<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>å’Œé›²ç¾½chillç¤¾ </title>
    <!-- å¼•å…¥ Bootstrap çš„ CSS æª”æ¡ˆ -->
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/logo.png">
    <script src="https://unpkg.com/mqtt/dist/mqtt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.5.1/math.min.js"></script>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <!-- Add the Firebase Analytics SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
    <!-- Add the Firebase Realtime Database SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- å¼•å…¥ jQuery å’Œ Bootstrap çš„ JS æª”æ¡ˆ -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- å¼•å…¥ Toastify çš„ CSS & JSæ–‡ä»¶  -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.6.1/toastify.min.css"
        integrity="sha512-UiKdzM5DL+I+2YFxK+7TDedVyVm7HMp/bN85NeWMJNYortoll+Nd6PU9ZDrZiaOsdarOyk9egQm6LOJZi36L2g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.6.1/toastify.min.js"
        integrity="sha512-79j1YQOJuI8mLseq9icSQKT6bLlLtWknKwj1OpJZMdPt2pFBry3vQTt+NZuJw7NSd1pHhZlu0s12Ngqfa371EA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        .team-color-board {
            border: 3px solid rgb(115, 104, 104);
            box-shadow: 0 0 0 3px black;
        }

        .team-color-0 {
            background-color: #ffd7e9;
            /* border: 3px solid #ffd7e9; */
        }

        .team-color-1 {
            background-color: #d7f2ff;
        }

        .team-color-2 {
            background-color: #fff7c7;
        }

        .team-color-3 {
            background-color: #c7ffd7;
        }

        .team-color-4 {
            background-color: #e7d7ff;
        }

        .team-color-5 {
            background-color: #ffe7d7;
        }

        .team-color-6 {
            background-color: #f0e3e3;
        }

        .team-color-7 {
            background-color: #d7ffeb;
        }

        .team-color-8 {
            background-color: #ffd7dc;
        }

        .team-color-9 {
            background-color: #d7f7ff;
        }

        .team-color-10 {
            background-color: #fff2d7;
        }

        .team-color-11 {
            /* background-color: #eaa69d; */
            border: 10px solid #eaa69d;
        }

        .selected {
            background-color: #007bff;
            color: #fff;
            border: 2px solid #010b17;
        }

        .choosed {
            background-color: yellowgreen;
        }

        .even {
            background-color: rgb(122, 176, 223);
        }

        .odd {
            background-color: antiquewhite;
        }

        .court {
            background-color: rgb(236, 236, 244);
            border: 2px solid white;
        }

        .row>div {
            padding: 5px;
        }

        .court td {
            /* margin-top: 10px; */
            height: 120px;
        }

        .court .net {
            background-color: aliceblue;
            height: 5px;
        }

        .main-container {
            background-color: gray;
        }

        .gameStart {
            background-color: greenyellow;
            width: 45%;
        }

        .gameEnd {
            background-color: red;
            width: 45%;
            color: aliceblue;
        }

        .person-span {
            margin: 3px;
            border: 1px solid black;
            /* background-color: white; */
        }

        .court-5 {
            /* background-color: white; */
            background-color: burlywood;

        }

        .court-1 {
            /* background-color: lightcoral; */
            background-color: MediumSeaGreen;

        }

        .court-2 {
            background-color: lightgreen;
        }

        .court-3 {
            background-color: MediumSeaGreen;
            /* background-color: lightblue; */
        }

        .court-4 {
            /* background-color: lightyellow; */
            background-color: lightgreen;

        }

        .analysis td {
            height: auto;
        }

        .personal_table {
            background-color: aliceblue;
            margin: 2px;
            border-radius: 3px;
        }

        .json {
            width: 100%;
        }

        .simplify_able_true {
            visibility: hidden;
        }

        .choosed {
            background-color: rgb(216, 235, 133);
        }
    </style>
</head>

<body>
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- æ¨¡æ…‹æ¡†çš„å…§å®¹ -->
                <div class="record_score_area">
                    <select name="ss" id="which_game">
                        <option value="1">1,2 VS 3,4</option>
                        <option value="1">1,2 VS 3,4</option>
                        <option value="1">1,2 VS 3,4</option>

                    </select>
                    <table class="table">
                        <tr>
                            <td id="player-1-td">1è™Ÿ</td>
                            <td id="player-4-td">4è™Ÿ</td>
                            <td><input id="top_team_score" type="number"></td>
                        </tr>
                        <tr>
                            <td id="player-2-td">2è™Ÿ</td>
                            <td id="player-3-td">3è™Ÿ</td>
                            <td><input id="bottom_team_score" type="number"></td>
                        </tr>
                        <tr>
                            <td><button id="delete_record_score" class="btn btn-primary">åˆªé™¤ç‰¹å®šå ´æ¬¡ç´€éŒ„</button></td>
                            <td></td>
                            <td><button id="record_score" class="btn btn-primary">ç™»è¨˜åˆ†æ•¸</button></td>
                        </tr>

                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="adjust_score_Modal">
        <div class="modal-dialog">
            <div class="modal-content modal_content_style">
                <!-- æ¨¡æ…‹æ¡†çš„å…§å®¹ -->
                <div class="select_div">
                    é¸æ“‡çš„äººï¼š<select name="" id="adjust_score_select"></select>
                </div>
                <div class="">
                    æŒ‡å®šåˆ†æ•¸ï¼š<input id="adjust_target_point_input" type="number">
                </div>
                <div class="">
                    <button id="adjust_point_confirm_button">åŸ·è¡Œèª¿æ•´åˆ†æ•¸</button>
                </div>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">ç¾½Chillç¤¾ ä¸»æ§å°</a>
        </div>
    </nav>
    <div class="container-fluid main-container">
        <div class="row court-container">
        </div>

        <div class="row">
            <div class="col-4">
                <div>
                    <button class="btn-primary btn" id="pickPeople"> é¸äººä¸Šå ´</button>
                    <button class="go_to_pk btn-primary btn" id="go_to_pk">å»ï¼Ÿçƒå ´æ¯”è³½</button>
                    <button id="open_modal_of_record_score" class="btn btn-primary ml-2">ç™»å…¥åˆ†æ•¸</button>
                    <span class="wait_to_register_text" id="wait_to_register_text">å¾…ç™»è¨˜ï¼š</span>
                    <button class="go_to_pk btn-primary btn" id="upload_data_to_firebase">ä¸Šå‚³é›²ç«¯</button>
                    <button class="go_to_pk btn-primary btn" id="backup_data_to_firebase">ä¸Šå‚³å‚™ä»½è³‡æ–™åˆ°é›²ç«¯</button>
                </div>
                <div class="col">
                    <table class="table table-bordered court-5 court">
                        <tr>
                            <td class="player1 go_here"></td>
                            <td class="player4 go_here"></td>
                        </tr>
                        <tr>
                            <td class='net top'> </td>
                            <td class='net bottom'> </td>
                        </tr>
                        <tr>
                            <td class="player2 go_here"></td>
                            <td class="player3 go_here"></td>
                        </tr>
                    </table>
                    <div>
                        <button class="button" id="check-info">æª¢è¦–è³‡æ–™</button>
                        <button class="button" id="refresh-idle">åˆ·æ–°é–’ç½®äººå“¡è³‡æ–™</button>
                        <button class="button" id="save-data">å­˜è³‡æ–™</button>
                        <button class="button" id="prepare_to_delete">æº–å‚™è¨­å®šäººå“¡ </button>
                        <button class="button" id="delete_today_data">åˆªé™¤æœ¬åœ°ç«¯ç•¶æ—¥è³‡æ–™ </button>
                    </div>
                    <fieldset>
                        <legend>ç’°å¢ƒè®Šæ•¸è¨­å®šå€</legend>
                        <select id="hide_score">
                            <option value="0">é¡¯ç¤ºåˆ†æ•¸</option>
                            <option value="1">éš±è—åˆ†æ•¸</option>
                        </select>
                        <select id="score_count">
                            <option value="1">åˆ†å·®*10åˆ†</option>
                            <option value="2">åˆ†å·®*20åˆ†</option>
                        </select>
                        <select id="simplify_do">
                            <option value="1">ç°¡åŒ–æ“ä½œæµç¨‹</option>
                            <option value="0">ä¸ç°¡åŒ–æ“ä½œæµç¨‹</option>
                        </select>
                        <select id="off_court_check">
                            <option value="1">ä¸‹å ´éœ€è¦ç¢ºèª</option>
                            <option value="0">ä¸‹å ´ä¸éœ€è¦ç¢ºèª</option>
                        </select>
                        <button id="clear_global_config">æ¸…é™¤è¨­å®š</button>
                    </fieldset>
                    <fieldset class="simplify_able">
                        <legend>å€‹äººæˆ°ç¸¾æŸ¥è©¢</legend>
                        <select name="personal_record" id="personal_record">
                        </select>
                        <button id="set_personal_record">ç¢ºèªåŸ·è¡Œ</button>
                        <button class="button" id="show_game_record">é¡¯ç¤ºæ‰€æœ‰æ¯”è³½ç´€éŒ„ </button>
                    </fieldset>
                </div>
            </div>
            <div class="col-8">
                <div class="row person-wait card-container"></div>
                <h2> æ“ä½œæŒ‰éˆ•å€</h2>
                <div class="row button-group">
                    <button id="binding" class="btn btn-primary ml-2">ç¶å®š</button>
                    <button id="go_to_sleep" class="btn btn-primary ml-2">å»ä¼‘æ¯å€</button>
                    <button id="go_to_wait" class="btn btn-primary ml-2">å»å‚™æˆ°å€</button>
                    <button id="cancel_binding" class="btn btn-primary ml-2">è§£é™¤ç¶å®š</button>
                    <button id="cancel_choosed" class="btn btn-primary ml-2">æ¸…é™¤é¸å–</button>
                    <button id="one_click_to_wait" class="btn btn-primary ml-2">ä¸€éµå‚™æˆ°</button>
                    <button id="adjust_point" class="btn btn-primary ml-2">ç©åˆ†èª¿æ•´</button>
                </div>
                <h1> ä¼‘æ¯å€</h1>
                <div class="row person-sleep"></div>
                <!-- å¤šè¡Œæ–‡æœ¬è¼¸å…¥æ¡† -->
                <textarea id="input" rows="5"></textarea>
                <!-- æŒ‰éˆ• -->
                <button onclick="processInput()">è™•ç†è¼¸å…¥</button>
                <div id="all_data_area"></div>
                <div id="bulletin_board">
                    <h1>ğŸ“°å…¬å¸ƒæ¬„ğŸ“°</h1>
                    <div id="bulletin_board_message"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <table id="game_record" class="table-bordered"></table>
            </div>
        </div>

    </div>

</body>

</html>

<script>
    //TODO: åˆ·æ–°äººæœƒå°è‡´ ä¸Šå ´é¡è‰²éºå¤± 
    //TODO: é‡æ•´é é¢ æœƒå°è‡´ prepare pk è³‡æ–™ä¸åŒ æ‡‰æ¯æ¬¡è®Šå‹•éƒ½å­˜æª”
    //firebase ç›¸é—œè¨­å®š 
    const firebaseConfig = {
        apiKey: "AIzaSyCCLXKg7Ru5p5dtgyRs28-qg8LQaG69yME",
        // authDomain: "friendly-sensor-137111.firebaseapp.com",
        databaseURL: "https://friendly-sensor-137111-default-rtdb.firebaseio.com",
        projectId: "friendly-sensor-137111",
        storageBucket: "friendly-sensor-137111.appspot.com",
        // messagingSenderId: "824581584416",
        appId: "1:824581584416:web:fdd5462dd85230d8caae45",
        measurementId: "G-2HYJ96RDLV"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    // ç²å–è³‡æ–™åº«çš„å¼•ç”¨
    const database = firebase.database();
    //é€™äº›è®Šæ•¸æœƒå¯«å…¥local storage
    let todayPeople = [];
    let prepare_PK = [];
    let empty_court_arr = [1, 2, 3, 4];
    let game_record = [];
    let bulletin_board_message = []
    let binding_team_list = []
    let wait_to_register_list = []
    //wait to register list æ”¹è®Šé‚è¼¯ è®Šæˆ æ°¸ä¹…ç´€éŒ„æ¯ä¸€å ´ 
    //é€™äº›è®Šæ•¸ æ¯æ¬¡é€²ä¾†æœƒé‡ç½®æˆé€™æ¨£
    let simplify = '1';
    let hide_score = '0';
    let score_count = '1';
    let off_court_check = '1';
    let global_config = {
        albert_fisher: 1
    }
    //ç”¢ç”Ÿ4å€‹ä¸»è¦æ¯”è³½å ´åœ°
    for (let i = 1; i < 5; i++) {
        $(".court-container").append(court_generate(i))
    }
    //å¾local storage è¼‰å…¥è³‡æ–™ è‹¥æ²’æœ‰è³‡æ–™å‰‡ç”¢ç”Ÿå‡è³‡æ–™
    if (!load_data()) {
        for (let i = 1; i <= 28; i++) {
            todayPeople.push({ id: i, name: `Object ${i}`, score: 500 - i, court: 0, idleRounds: 0, player: 0, partner_id: 0, choosed: 0, game_count: 0, on_court_time: 0 });
        }
    }

    /**
     * é¡¯ç¤ºè¨Šæ¯
     * @param {string} message - è¦é¡¯ç¤ºçš„è¨Šæ¯
     * @param {string} [state="success"] - è¨Šæ¯çš„ç‹€æ…‹ï¼Œå¯ä»¥æ˜¯ "success"ã€"error"ã€"warning" æˆ– 
                "client_ok"ã€  "client_error" ä¸­çš„ä»»æ„ä¸€å€‹ï¼ˆé»˜èªæ˜¯ "success"ï¼‰
     * @returns {void}
     * success æ“ä½œæˆåŠŸ
     * error å‡ºç¾å¤§éŒ¯äº†ï¼ æ­£å¸¸æ“ä½œ ç„¡è«–å¦‚ä½•éƒ½ä¸è©²å‡ºç¾ï¼ æœ‰å‡ºç¾å°±è¦å»debug
     * warning æ­£å¸¸æ“ä½œä¸‹çš„é•è¦æ“ä½œ   æé†’æ­¤æ“ä½œç„¡æ•ˆå³å¯
     */
    function show_message(message, state = "success") {
        const state_dict_map_backgroundColor = {
            //ç¶ è‰²ç³»ç‰ˆæœ¬ï¼šè¡¨æˆåŠŸ
            success: "linear-gradient(to right, #00b09b, #96c93d)",
            //ç´…è‰²ç³»ç‰ˆæœ¬ï¼šè¡¨å±éšª éŒ¯èª¤
            error: "linear-gradient(to right, #ff416c, #ff4b2b)",
            //é»ƒè‰²ç³»ç‰ˆæœ¬ï¼šè¡¨è­¦å‘Š
            warning: "linear-gradient(to right, #fbb034, #ffdd00)",
            //è—è‰²ç³»ç‰ˆæœ¬ï¼šä¾†è‡ªclientç«¯çš„æ“ä½œæˆåŠŸ
            client_ok: "linear-gradient(to right, #00bfff, #0072ff)",
            //ç´«è‰²ç³»ç‰ˆæœ¬ï¼šä¾†è‡ªclientç«¯çš„æ“ä½œå¤±æ•—
            client_error: "linear-gradient(to right, #9b50ff, #a849ff)",
        }
        if (state_dict_map_backgroundColor[state] == undefined) {
            return show_message("show_messageæ”¶åˆ°ä¸ç¬¦åˆçš„ state", "error")
        }
        if (typeof message !== "string") {
            return show_message("show_messageæ”¶åˆ°ä¸ç¬¦åˆçš„ message", "error")
        }
        Toastify({
            text: message,
            duration: 3000, // è¨­å®šé¡¯ç¤ºæ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
            newWindow: true,
            close: true,
            gravity: "bottom", // è¨­å®šé¡¯ç¤ºä½ç½®
            position: "right",
            backgroundColor: state_dict_map_backgroundColor[state],
            stopOnFocus: true // åœ¨ç„¦é»è™•æ–¼æç¤ºè¨Šæ¯ä¸Šæ™‚åœæ­¢é¡¯ç¤º
        }).showToast();
    }
    //court ç›¸é—œçš„function
    function show_player_data_to_court(topTeamPlayers, bottomTeamPlayers, court) {
        //topTeamPlayers, bottomTeamPlayers éƒ½æ˜¯array æ”¾äº†å…©å€‹é¸æ‰‹çš„è³‡æ–™
        //court æ˜¯ int è¡¨ç¤ºç¬¬å¹¾å ´æ¬¡
        if (topTeamPlayers.length != 2 || bottomTeamPlayers.length != 2) {
            return (show_message("é¡¯ç¤ºé¸æ‰‹è³‡æ–™åˆ°å ´åœ° ç™¼ç”ŸéŒ¯èª¤(é¸æ‰‹åˆ—è¡¨)"), "error")
        }
        if (court < 0 || court > 5) {
            return (show_message("é¡¯ç¤ºé¸æ‰‹è³‡æ–™åˆ°å ´åœ° ç™¼ç”ŸéŒ¯èª¤(å ´åœ°)"), "error")
        }
        console.log(topTeamPlayers)
        console.log(bottomTeamPlayers)
        $(`.court-${court} .player1`).html(personal_card(topTeamPlayers[0]))
        $(`.court-${court} .player2`).html(personal_card(bottomTeamPlayers[0]))
        $(`.court-${court} .player3`).html(personal_card(bottomTeamPlayers[1]))
        $(`.court-${court} .player4`).html(personal_card(topTeamPlayers[1]))
        $(`.court-${court} .top`).html(`â†‘ï¼š${topTeamPlayers[0].score + topTeamPlayers[1].score}`)
        $(`.court-${court} .bottom`).html(`â†“ï¼š${bottomTeamPlayers[0].score + bottomTeamPlayers[1].score}`)
        if (court == 5) {
            const id_list = [topTeamPlayers[0].id, topTeamPlayers[1].id, bottomTeamPlayers[0].id, bottomTeamPlayers[1].id,]
            $(".team-color-board").removeClass('team-color-11')
            id_list.forEach(obj => $(`#${obj}`).addClass('team-color-11'))
        }
    }
    function empty_data_to_court(court) {
        if (court < 1 || court > 5) {
            show_message("æ¸…ç©ºå ´åœ°ç™¼ç”Ÿå•é¡Œ", "error")
        }
        $(`.court-${court} .player1`).empty()
        $(`.court-${court} .player2`).empty()
        $(`.court-${court} .player3`).empty()
        $(`.court-${court} .player4`).empty()
        $(`.court-${court} .top`).empty()
        $(`.court-${court} .bottom`).empty()
        if (court == 5) {
            $(".team-color-board").removeClass('team-color-11')
        }
    }
    //ç”¢ç”Ÿæ–‡å­—æª”é¡
    function personal_card(person) {
        if (person == undefined) {
            show_message("personal cardçš„åƒæ•¸æœ‰èª¤ å‚³å…¥UNDEFINED", "error")
            return
        }
        if (person.name == undefined || person.score == undefined) {
            show_message("personal cardçš„åƒæ•¸æœ‰èª¤", "error")
            return
        }
        return (`${person.name}<br>âš”ï¸ï¼š${hide_score == 1 ? '???' : person.score}`)
    }
    function court_generate(court_number) {
        if (court_number < 1 || court_number > 5) {
            show_message("ç”Ÿæˆå ´åœ°è³‡è¨Šç™¼ç”Ÿå•é¡Œ", "error")
        }
        return (`<div class="col-sm">
                <table class="table table-bordered court-${court_number} court">
                    <tr>
                        <td class="player1 td-court-${court_number} td-click"></td>
                        <td class="player4 td-court-${court_number} td-click"></td>
                    </tr>
                    <tr>
                        <td class='net top'> </td>
                        <td class='net bottom'> </td>
                    </tr>
                    <tr>
                        <td class="player2 td-court-${court_number} td-click"></td>
                        <td class="player3 td-court-${court_number} td-click"></td>
                    </tr>
                </table>
                <button class="gameStart simplify_able" id="court${court_number}start">æ¯”è³½é–‹å§‹</button>
                <button class="gameEnd" id="court${court_number}end">æ¯”è³½çµæŸ</button>
            </div>`)
    }

    //é‡è¦å½±éŸ¿è³‡æ–™çš„å‡½æ•¸-å‹•ä½œ 
    function pickPeople() {
        //è§¸ç™¼æ™‚æ©Ÿï¼šç•¶æŒ‰ä¸‹é¸äººæŒ‰éˆ• æˆ–æ˜¯ è‡ªå‹•ç°¡åŒ–æ¨¡å¼æ™‚ æŒ‰ä¸‹ä¸‹å ´æŒ‰éˆ•æ™‚æœƒè‡ªå‹•é¸äºº
        //ä¸»è¦å½±éŸ¿ prepare_PK
        const people = todayPeople.filter(person => person['court'] == 0 && person['idleRounds'] >= 0);
        if (people.length < 8) {
            show_message("åœ¨å‚™æˆ°å€çš„äººæ•¸ä¸è¶³8äºº æ¼”ç®—æ³•å¤±éˆ", "error")
            return
        }
        const four_people = letsPlay(todayPeople, binding_team_list)
        // const four_people = pick_weight_count(todayPeople, binding_team_list)
        const pickedPeople = [todayPeople[four_people[0] - 1], todayPeople[four_people[1] - 1], todayPeople[four_people[2] - 1], todayPeople[four_people[3] - 1]]
        console.log(todayPeople)
        prepare_PK_refresh(pickedPeople)
    }
    function go_to_PK() {
        // è§¸ç™¼æ™‚æ©Ÿ æŒ‰ä¸‹å»çƒå ´æ¯”è³½ æˆ–è‡ªå‹•ç°¡åŒ–æ¨¡å¼æ™‚ æŒ‰ä¸‹ä¸‹å ´æŒ‰éˆ•æ™‚æœƒè‡ªå‹•ä¸Šå ´
        // ä¸»è¦å½±éŸ¿ todayPeople çš„court & player, prepare_PK , empty_court_arr
        // æŠŠè³‡æ–™æ”¹ä¸Šå» ä¸¦é¡¯ç¤ºäººå“¡åœ¨å°çš„ä½ç½®
        if (empty_court_arr.length == 0) {
            alert("ç¾åœ¨æ²’æœ‰ç©ºå ´ ç„¡æ³•é€²è¡Œæ¯”è³½")
            return
        }
        if (prepare_PK.length != 4) {
            return (alert("è«‹å…ˆé¸äºº å†å»PK"))
        }
        const court = empty_court_arr.shift()
        console.log("court")
        console.log(court)
        //!!! prepare_PK ä¸ä¸€å®šæœƒè·Ÿtoday_peopleçš„ç‰©ä»¶å®Œå…¨ç¶å®šï¼ï¼ï¼
        //æ•…åªä¿®æ”¹prepare_PKå¯èƒ½é€ æˆéŒ¯èª¤
        prepare_PK.forEach((person, index) => {
            person.court = court;
            person.player = index + 1;
            person.game_count += 1;
            todayPeople[person.id - 1].court = court
            todayPeople[person.id - 1].player = index + 1;
            todayPeople[person.id - 1].game_count += 1;
        });
        show_player_data_to_court([prepare_PK[0], prepare_PK[3]], [prepare_PK[1], prepare_PK[2]], court)
        const now = new Date();
        const timezoneOffsetInMs = now.getTimezoneOffset() * 60 * 1000;
        const currentTimeInMs = now.getTime() - timezoneOffsetInMs;
        const currentTime = new Date(currentTimeInMs);
        const hours = currentTime.getHours().toString().padStart(2, '0');
        const minutes = currentTime.getMinutes().toString().padStart(2, '0');
        const seconds = currentTime.getSeconds().toString().padStart(2, '0');
        const currentTime_hms = `${hours}:${minutes}:${seconds}`
        bulletin_board_message.push([prepare_PK[0].name, prepare_PK[1].name, prepare_PK[2].name, prepare_PK[3].name, court, currentTime_hms])
        refresh_bulletin_board_message()
        const speak_text1 = String(`å¤§æœƒå ±å‘Š`)
        speak(speak_text1, times = 1, rate = 0.8);
        const speak_text2 = String(`ã€Š${prepare_PK[0].name}ã€‹ å’Œ ã€Š${prepare_PK[3].name}ã€‹ å°æˆ° ã€Š${prepare_PK[1].name}ã€‹ å’Œ ã€Š${prepare_PK[2].name}ã€‹ï¼Œè«‹è‡³ç¬¬${court}çƒå ´æ¯”è³½ã€‚`)
        speak(speak_text2, times = 3, rate = 0.7);
        todayPeople.forEach(person => {
            if (person.court == 0 || person.court == -1) {
                person.idleRounds += 1;
            } else {
                person.idleRounds = 0;
            }
        })
        prepare_PK_refresh([]);
        idle_people_update_to_div()
    }


    // æ“æ§ æº–å‚™ä¸Šå ´äººå“¡çš„å‡½æ•¸ åªè¦æœƒå‹•åˆ°prepare_PK éƒ½æ‡‰è©²é€éé€™å€‹å‡½æ•¸æ“ä½œ
    function prepare_PK_refresh(pickedPeople, index = -1) {
        //åªä½¿ç”¨ä¸€å€‹åƒæ•¸çš„æ™‚å€™ å°±æ˜¯æ•´å€‹æ›¿æ›prepare_PK
        //ä½¿ç”¨å…©å€‹åƒæ•¸çš„æ™‚å€™ indexè¡¨ç¤ºè¦æ›¿æ›å“ªä¸€å€‹prepare_PKçš„äºº å¾0-3 è¡¨ç¤ºplayer1-4
        //é€™å€‹å‡½æ•¸ ä¹ŸåŒæ™‚æ§åˆ¶è³½å ´çš„é¡¯ç¤ºé‚„æœ‰å­˜åœ°ç«¯å’Œé›²ç«¯
        if (index == -1) {
            prepare_PK = pickedPeople
        }
        if (index < 4 && index > -1) {
            prepare_PK[index] = pickedPeople
        }
        save_data()
        if (pickedPeople.length == 0) {
            empty_data_to_court(5);
        }
        if (pickedPeople.length == 4) {
            show_player_data_to_court([prepare_PK[0], prepare_PK[3]], [prepare_PK[1], prepare_PK[2]], 5)
        }
        send_prepare_PK_to_firebase()

    }

    //ä¿®æ”¹court ä¸‹å ´ä¼‘æ¯ è‡ªå‹•è§£é™¤ç¶å®š
    function court_change(person, binding_list, change_number = -1) {
        // person ä¸€å€‹äººç‰©ç‰©ä»¶ 
        // binding_list æ°¸é æ‡‰è©²å‚³å…¥ binding_team_list
        // change_number æŠŠé€™å€‹äººçš„court æ”¹æˆå¤šå°‘ ä¸€èˆ¬å»ä¼‘æ¯æ‰ä½¿ç”¨ æ‰€ä»¥æ˜¯-1
        const temp_id = person.id
        let binding_list_index = -1
        //æª¢æŸ¥æ˜¯å¦åœ¨ç¶å®šçš„åˆ—è¡¨ä¸­
        binding_list.forEach((binding, index) => {
            if (binding.includes(temp_id)) {
                binding_list_index = index
            }
        })
        if (binding_list_index != -1) {
            binding_list.splice(binding_list_index, 1)
        }
        person.court = change_number

    }
    //å±•ç¤ºè³‡æ–™é¡å‹
    function refresh_bulletin_board_message() {
        $("#bulletin_board_message").empty()
        bulletin_board_message.forEach(obj => $("#bulletin_board_message").prepend((`ã€Š${obj[0]}ã€‹ å’Œ ã€Š${obj[3]}ã€‹ å°æˆ° ã€Š${obj[1]}ã€‹ å’Œ ã€Š${obj[2]}ã€‹ï¼Œè«‹è‡³ç¬¬${obj[4]}çƒå ´æ¯”è³½ã€‚<br>`)))
    }

    function handle_one_click_to_wait() {
        todayPeople.filter(obj => obj.court == -1).forEach(obj => obj.court = 0)
        idle_people_update_to_div()
    }
    function idle_people_update_to_div() {
        const idle_people = todayPeople.filter(obj => obj.court === 0 || obj.court === -1).sort((a, b) => b.idleRounds - a.idleRounds)
        $(".person-wait").empty()
        $(".person-sleep").empty()
        idle_people.forEach(obj => {

        })
        for (x in idle_people) {
            if (idle_people[x].court == -1) {
                $(".person-sleep").append(idle_personal_card(idle_people[x]))
            }
            if (idle_people[x].court == 0) {
                $(".person-wait").append(idle_personal_card(idle_people[x]))
            }
            idle_people[x].choosed = 0;
        }
        console.log(binding_team_list)
        binding_team_list.forEach((obj, index) => {
            obj.forEach((in_obj, in_index) => {
                $(`#${in_obj}`).addClass(`team-color-${index}`)
            })
        })
        $(".selectable").click(handle_personal_card_click)
        upload_real_time_data_todayPeople_to_firebase()
        save_data()
    }
    function idle_personal_card(person) {
        return (`
        <div class='col-md-2'>
        <div class="card selectable team-color-board" id='${person.id}'>
                        <div class="card-body">
                            <h5 class="card-title">${person.name}</h5>
                            <p class="card-text">${hide_score == 1 ? '???' : person.score}ï¼${person.idleRounds}</p>
                        </div>
                    </div>
                    </div>`)
    }
    function handle_personal_card_click(e) {
        const click_id = parseInt(e.currentTarget.id)
        console.log(`#${e.currentTarget.id}`)
        if (todayPeople[click_id - 1].choosed == 1) {
            $(`#${e.currentTarget.id}`).removeClass("selected")
            todayPeople[click_id - 1].choosed = 0;
        } else {
            todayPeople[click_id - 1].choosed = 1;
            $(`#${e.currentTarget.id}`).addClass("selected")
        }


    }
    function handle_end_game_new(e) {
        const str = e.target.id;
        const sixthChar = str.charAt(5); // å–å¾—ç¬¬å…­å€‹å­— (å¾ 0 é–‹å§‹ç®—)
        const court_number = parseInt(sixthChar, 10); // å°‡ç¬¬å…­å€‹å­—è½‰æ›æˆæ•¸å­— (10 ä»£è¡¨ä½¿ç”¨åé€²åˆ¶)
        console.log(empty_court_arr)
        console.log(court_number)
        if (empty_court_arr.includes(court_number)) {
            return (alert(`ç¬¬${court_number}å ´é‚„æ˜¯ç©ºçš„ ç„¡æ³•çµæŸæ¯”è³½`))
        }
        if (off_court_check == '1') {
            var confirmed = confirm(`ç¬¬${court_number}çƒå ´çš„æ¯”è³½ ç¢ºèªåŸ·è¡ŒçµæŸä¸‹å ´å—ï¼Ÿ`);
            if (confirmed) {
                off_court_new(court_number)
            }
        } else {
            off_court_new(court_number)
        }
    }
    function off_court_new(court_number) {
        const result = todayPeople.filter(obj => obj.court === court_number);
        const temp_id_list = [1, 2, 3, 4]
        let temp_name_list = []
        result.forEach(obj => {
            temp_id_list[Number(obj.player) - 1] = obj.id
            obj.court = 0;
        })
        wait_to_register_list.push(temp_id_list)
        temp_id_list.forEach(obj => temp_name_list.push(todayPeople[obj - 1].name))
        upload_wait_to_register_to_firebase(temp_name_list)
        empty_data_to_court(court_number)
        empty_court_arr.push(Number(court_number))
        console.log("empty_court_arr å¢åŠ " + court_number)
        idle_people_update_to_div()
        save_data()
        if (simplify == '1') {
            go_to_PK()
            pickPeople()
        }
        //å¯èƒ½è¦é€è³‡æ–™
        refresh_wait_to_register_text();
    }
    function handle_check_info() {
        console.log(todayPeople)
        console.log(empty_court_arr)
        console.log(prepare_PK)
        console.log(game_record)
        const todayPeople_json = JSON.stringify(todayPeople);
        const empty_court_arr_json = JSON.stringify(empty_court_arr);
        const prepare_PK_json = JSON.stringify(prepare_PK);
        const game_record_json = JSON.stringify(game_record);
        const bulletin_board_message_json = JSON.stringify(bulletin_board_message);
        $("#all_data_area").append(`<textarea id = "todayPeople_data" class="json" > ${todayPeople_json}</textarea > `)
        $("#all_data_area").append(`<textarea id = "empty_court_arr_data" class="json" > ${empty_court_arr_json}</textarea > `)
        $("#all_data_area").append(`<textarea id = "prepare_PK_data" class="json" > ${prepare_PK_json}</textarea > `)
        $("#all_data_area").append(`<textarea id = "game_record_data" class="json" > ${game_record_json}</textarea > `)
        $("#all_data_area").append(`<textarea id = "game_record_data" class="json" > ${bulletin_board_message_json}</textarea > `)
        $("#all_data_area").append(`éå¿…è¦ä¸è¦ä½¿ç”¨é€™å€‹åŠŸèƒ½ æ ¼å¼éŒ¯å°±æœƒGGå–”`)
        $("#all_data_area").append(`<button id = "edit_save" > å„²å­˜ä¿®æ”¹çš„è³‡æ–™ </button > `)
        $("#all_data_area").append(`<button id = "edit_off" > é€€å‡ºç·¨è¼¯æ¨¡å¼ </button > `)
        $("#edit_save").on("click", handle_edit_save)
        $("#edit_off").on("click", handle_edit_off)
    }
    function save_data() {
        // å°‡ç‰©ä»¶é™£åˆ—è½‰æ›ç‚º JSON å­—ä¸²
        const todayPeople_json = JSON.stringify(todayPeople);
        const empty_court_arr_json = JSON.stringify(empty_court_arr);
        const prepare_PK_json = JSON.stringify(prepare_PK);
        const game_record_json = JSON.stringify(game_record);
        const bulletin_board_message_json = JSON.stringify(bulletin_board_message);
        const wait_to_register_list_json = JSON.stringify(wait_to_register_list);
        const binding_team_list_json = JSON.stringify(binding_team_list)
        console.log("save")
        console.log(todayPeople)
        // å°‡ JSON å­—ä¸²å­˜å…¥æœ¬åœ°å­˜å„²ä¸­
        localStorage.setItem('todayPeople', todayPeople_json);
        localStorage.setItem('empty_court_arr', empty_court_arr_json);
        localStorage.setItem('prepare_PK', prepare_PK_json);
        localStorage.setItem('game_record', game_record_json);
        localStorage.setItem('bulletin_board_message', bulletin_board_message_json);
        localStorage.setItem('wait_to_register_list', wait_to_register_list_json);
        localStorage.setItem('binding_team_list', binding_team_list_json);
    }
    function load_data() {
        if (localStorage.getItem('todayPeople') == undefined || localStorage.getItem('empty_court_arr') == undefined || localStorage.getItem('prepare_PK') == undefined) {
            return false
        }
        // å¾æœ¬åœ°å­˜å„²ä¸­å–å‡º JSON å­—ä¸² ä¸¦ä¸”è½‰æ› æ”¾å…¥ æ­£åœ¨ç”¨çš„è³‡æ–™
        todayPeople = JSON.parse(localStorage.getItem('todayPeople'));
        empty_court_arr = JSON.parse(localStorage.getItem('empty_court_arr'));
        prepare_PK = JSON.parse(localStorage.getItem('prepare_PK'));
        game_record = JSON.parse(localStorage.getItem('game_record'));
        wait_to_register_list = JSON.parse(localStorage.getItem('wait_to_register_list')) ? JSON.parse(localStorage.getItem('wait_to_register_list')) : [];
        bulletin_board_message = JSON.parse(localStorage.getItem('bulletin_board_message')) ? JSON.parse(localStorage.getItem('bulletin_board_message')) : [];
        binding_team_list = JSON.parse(localStorage.getItem('binding_team_list')) ? JSON.parse(localStorage.getItem('binding_team_list')) : [];
        put_todayPeople_to_court()
        return true
    }
    function put_todayPeople_to_court() {
        for (let court = 1; court < 6; court++) {
            const temp_arr = todayPeople.filter(obj => obj.court == court)
            if (temp_arr.length != 0) {
                temp_arr.sort((a, b) => a.player - b.player);
                show_player_data_to_court([temp_arr[0], temp_arr[3]], [temp_arr[1], temp_arr[2]], court)
            }
        }
        if (prepare_PK.length == 4) {
            show_player_data_to_court([prepare_PK[0], prepare_PK[3]], [prepare_PK[1], prepare_PK[2]], 5)
        }
        //TODO:æ‡‰è©²è¦ä¸Šå‚³è³‡æ–™åˆ°firebase
    }
    function processInput() {
        let confirmed = confirm("ç¢ºå®šè¼¸å…¥å—ï¼Ÿ æ­¤æ“ä½œå°‡å°è‡´ä»Šå¤©çš„è³‡æ–™é‡ç½®ï¼")
        if (confirmed == false) {
            return
        }
        // ç²å–è¼¸å…¥æ¡†ä¸­çš„å…§å®¹
        const input = document.getElementById('input').value;
        const converted_input = input.replace(/\*/g, '');
        // è™•ç†è¼¸å…¥
        console.log(converted_input);
        // å°‡è³‡æ–™è½‰æ›ç‚ºé™£åˆ— è®€å–ç‰¹å®šè³‡æ–™çš„æ ¼å¼è®Šæˆåˆ†æ•¸æ•¸æ“š
        const regex = /(\d+)\.\[(\d*\.?\d*)\](.*)/g;
        const result = [];
        while ((matches = regex.exec(converted_input)) !== null) {
            const id = parseInt(matches[1]);
            const score = matches[2] !== '' ? parseInt(parseFloat(matches[2]) * 100) : 0;
            const name = matches[3].trim();
            result.push({ id, score, name });
        }
        //åˆå§‹åŒ–
        todayPeople = [];
        prepare_PK = [];
        empty_court_arr = [1, 2, 3, 4];
        game_record = [];
        bulletin_board_message = []
        wait_to_register_list = []
        binding_team_list = []

        const today_play_list = []
        for (let i = 1; i <= result.length; i++) {
            todayPeople.push({ id: i, name: result[i - 1].name, score: result[i - 1].score, court: -1, idleRounds: 0, player: 0, partner_id: 0, choosed: 0, game_count: 0, on_court_time: 0 });
            today_play_list.push(result[i - 1].name)
        }
        for (let i = 1; i < 6; i++) {
            empty_data_to_court(i)
        }
        idle_people_update_to_div()
        save_data()
        //ä¸Šå‚³firebase çš„today_play_list
        reset_today_data_to_firebase()
        send_today_play_list_to_firebase(today_play_list)
    }
    function prepare_to_delete() {
        //å³å°‡æ£„ç”¨
        $("#delete").empty()
        $("#prepare_PK_person").empty()
        for (i = 0; i < todayPeople.length; i++) {
            $("#delete").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
        }
        for (i = 0; i < todayPeople.length; i++) {
            $("#prepare_PK_person").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
        }
        for (i = 0; i < todayPeople.length; i++) {
            $("#personal_record").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
            $("#binding_partners_2").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
            $("#binding_partners_1").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
        }

    }
    function handle_hide_score_change() {
        console.log('å°‡ hide_score è¨­ç½®ç‚ºï¼š' + $(this).val())
        hide_score = $(this).val()
        put_todayPeople_to_court()
        idle_people_update_to_div()
    }
    function handle_score_count_change() {
        console.log('å°‡ score_count è¨­ç½®ç‚ºï¼š' + $(this).val())
        score_count = $(this).val()
    }
    function handle_simplify_do_change() {
        console.log('å°‡ simplify è¨­ç½®ç‚ºï¼š' + $(this).val())
        simplify = $(this).val()
    }
    function handle_off_court_check_change() {
        console.log('å°‡ off_court_check è¨­ç½®ç‚ºï¼š' + $(this).val())
        off_court_check = $(this).val()
    }
    function handle_show_game_record() {
        $("#game_record").empty()
        for (x in game_record) {
            let y = game_record.length - x - 1
            let even_or_odd = y % 2 == 0 ? 'even' : "odd"
            $("#game_record").append(`
            <tr class='${even_or_odd}'><td>${game_record[y][0]}ã€${game_record[y][3]}</td><td>${game_record[y][1]}ã€${game_record[y][2]}</td></tr>
            <tr class='${even_or_odd}'><td>${game_record[y][4]}</td><td>${game_record[y][5]}</td></tr>
            `)
        }
    }
    function handle_set_personal_record() {
        console.log($("#personal_record").val())
        const the_name = todayPeople[Number($("#personal_record").val()) - 1].name
        $("#game_record").empty()
        for (x in game_record) {
            let y = game_record.length - x - 1
            if (game_record[y].includes(the_name))
                $("#game_record").append(`
        <tr >
                        <td>${game_record[y][0]}ã€${game_record[y][3]}</td>
                        <td>${game_record[y][1]}ã€${game_record[y][2]}</td>
                    </tr >
        <tr><td>${game_record[y][4]}</td><td>${game_record[y][5]}</td></tr>
    `)
        }
    }
    function handle_edit_save() {
        //å³å°‡æ£„ç”¨ æˆ–éœ€è¦æ”¹å¯«
        const todayPeople_json = $("#todayPeople_data").val()
        const empty_court_arr_json = $("#empty_court_arr_data").val()
        const prepare_PK_json = $("#prepare_PK_data").val()
        const game_record_json = $("#game_record_data").val()
        // å°‡ JSON å­—ä¸²å­˜å…¥æœ¬åœ°å­˜å„²ä¸­
        localStorage.setItem('todayPeople', todayPeople_json);
        localStorage.setItem('empty_court_arr', empty_court_arr_json);
        localStorage.setItem('prepare_PK', prepare_PK_json);
        localStorage.setItem('game_record', game_record_json);
        load_data()
    }
    function handle_edit_off() {
        $("#all_data_area").empty()
    }
    function speak(text, times = 1, rate = 1) {
        // åˆ›å»º SpeechSynthesisUtterance å¯¹è±¡
        var msg = new SpeechSynthesisUtterance();
        //æ–‡æœ¬é€Ÿåº¦
        msg.rate = rate;
        // è®¾ç½®è¦æœ—è¯»çš„æ–‡æœ¬
        msg.text = text.repeat(times);
        // æ’­æ”¾è¯­éŸ³
        window.speechSynthesis.speak(msg);

    }
    function handle_delete_today_data() {
        //å³å°‡æ£„ç”¨ ç§»å‹•åˆ°è™•ç†è¼¸å…¥é‚è¼¯
        const confirmed = confirm('ç¢ºå®šåˆªé™¤ä»Šæ—¥çš„è³‡æ–™å—ï¼Ÿ(ä¸€èˆ¬åªåœ¨å­˜å¥½è³‡æ–™å¾Œï¼Œè¦é–‹å§‹æ‰“ä¹‹å‰åˆªé™¤ï¼Œåˆªé™¤å¾Œè«‹å¥—ç”¨ç•¶æ—¥çƒæœ‰è³‡æ–™å†é–‹å§‹ä½¿ç”¨)')
        if (confirmed) {
            todayPeople = [];
            prepare_PK = [];
            empty_court_arr = [1, 2, 3, 4];
            game_record = [];
            bulletin_board_message = []
            wait_to_register_list = []
            save_data()
            load_data()
        }
    }
    function handle_binding() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        if (choosed_people.length > 4) {
            return (alert(`ç•¶å‰ç¶å®šåŠŸèƒ½ åªèƒ½æ¥å—æœ€å¤šå››äººç¶å®š`))
        }
        if (choosed_people.length < 2) {
            return (alert(`ç•¶å‰ç¶å®šåŠŸèƒ½ è‡³å°‘è¦å…©äººæ‰å¯ä»¥ç¶å®š`))
        }
        for (x in choosed_people) {
            const found = binding_team_list.some(function (row) {
                return row.includes(choosed_people[x].id);
            });
            if (found) {
                return (alert(`è«‹å…ˆç§»é™¤${choosed_people[x].name}çš„ç¶å®š å†é‡æ–°é€²è¡Œç¶å®š`))
            }
        }
        if (global_config.albert_fisher == 1) {
            if (choosed_people.filter(obj => obj.name == "ç‡•ç¾½").length == 1 && choosed_people.filter(obj => obj.name == "é˜¿æ‰¿").length == 1) {
                return (show_message("ç™¼ç”Ÿä¸å¯é æœŸçš„éŒ¯èª¤", "error"))
            }
        }

        const temp_binding = [];
        choosed_people.forEach(obj => {
            temp_binding.push(obj.id)
            obj.choosed = 0;
        })
        binding_team_list.push(temp_binding)
        idle_people_update_to_div()
    }
    function handle_go_to_sleep() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        if (choosed_people.length == 0) {
            return (show_message("æ²’æœ‰é¸äºº æ“ä½œç„¡æ•ˆ"))
        }
        choosed_people.forEach(obj => {
            // obj.court = -1;
            court_change(obj, binding_team_list, -1)
            obj.choosed = 0;
        })
        idle_people_update_to_div()
    }
    function handle_go_to_wait() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        if (choosed_people.length == 0) {
            return (show_message("æ²’æœ‰é¸äºº æ“ä½œç„¡æ•ˆ"))
        }
        choosed_people.forEach(obj => {
            obj.court = 0;
            obj.choosed = 0;
        })
        idle_people_update_to_div()
    }
    function handle_cancel_binding() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        const team_id_list = []
        choosed_people.forEach(obj => team_id_list.push(obj.id))
        var index = binding_team_list.findIndex(function (row) {
            return row.every(function (value, i) {
                return value === team_id_list[i];
            });
        });
        if (index != -1) {
            binding_team_list.splice(index, 1)
            choosed_people.forEach(obj => {
                obj.choosed = 0;
            })
            idle_people_update_to_div()
        } else {
            return (alert("è«‹æ­£ç¢ºæŒ‡å®šç§»é™¤ç¶å®šå°è±¡ï¼ˆå¿…é ˆæ˜¯åŒä¸€çµ„çš„å…¨éƒ¨äººï¼‰"))
        }
    }
    function handle_cancel_choosed() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        choosed_people.forEach(obj => {
            obj.choosed = 0;
        })
        idle_people_update_to_div()
    }
    function handle_record_score() {
        const now_which_game = parseInt($("#which_game").val())
        const top_team_score = parseInt($("#top_team_score").val())
        const bottom_team_score = parseInt($("#bottom_team_score").val())
        if (isNaN(top_team_score) || isNaN(bottom_team_score)) {
            return (alert("è«‹å…ˆå¡«å…¥åˆ†æ•¸ å†é€²è¡Œç™»è¨˜"))
        }
        record_score(now_which_game, top_team_score, bottom_team_score)
        $('#myModal').modal('hide');
    }
    function record_score(now_which_game_p, top_team_score_p, bottom_team_score_p) {
        const top_score_line = 1000
        const bottom_score_line = 100
        const record_database = database
        const now_which_game = parseInt(now_which_game_p)
        const top_team_score = parseInt(top_team_score_p)
        const bottom_team_score = parseInt(bottom_team_score_p)
        const player_list = [todayPeople[wait_to_register_list[now_which_game][0] - 1].name, todayPeople[wait_to_register_list[now_which_game][1] - 1].name, todayPeople[wait_to_register_list[now_which_game][2] - 1].name, todayPeople[wait_to_register_list[now_which_game][3] - 1].name]
        const temp_game_record = []
        console.log(now_which_game)
        temp_game_record.push(todayPeople[wait_to_register_list[now_which_game][0] - 1].name)
        temp_game_record.push(todayPeople[wait_to_register_list[now_which_game][1] - 1].name)
        temp_game_record.push(todayPeople[wait_to_register_list[now_which_game][2] - 1].name)
        temp_game_record.push(todayPeople[wait_to_register_list[now_which_game][3] - 1].name)
        temp_game_record.push(top_team_score)
        temp_game_record.push(bottom_team_score)
        temp_game_record.push(new Date())

        game_record.push(temp_game_record)

        const score_diff_scale = score_count == '1' ? 10 : score_count == 2 ? 20 : 10
        //è¨ˆç®—åˆ†æ•¸ï¼š
        const score_diff = top_team_score - bottom_team_score
        count_score_function(todayPeople[wait_to_register_list[now_which_game][0] - 1], (score_diff * score_diff_scale), top_score_line, bottom_score_line)
        count_score_function(todayPeople[wait_to_register_list[now_which_game][1] - 1], (score_diff * score_diff_scale) * -1, top_score_line, bottom_score_line)
        count_score_function(todayPeople[wait_to_register_list[now_which_game][2] - 1], (score_diff * score_diff_scale) * -1, top_score_line, bottom_score_line)
        count_score_function(todayPeople[wait_to_register_list[now_which_game][3] - 1], (score_diff * score_diff_scale), top_score_line, bottom_score_line)


        //å°‡é›²ç«¯ç™»è¨˜åˆ—è¡¨æ›´æ–°
        record_database.ref(`Chung_Shan_elementary_school/wait_to_register/`).once('value').then(snapshot => {
            console.log(snapshot.val())
            const data = snapshot.val()
            for (const key in data) {
                if (data[key].player1 == player_list[0] && data[key].player2 == player_list[1] && data[key].player3 == player_list[2] && data[key].player4 == player_list[3]) {
                    record_database.ref(`Chung_Shan_elementary_school/wait_to_register/${key}`).update({
                        register_name: "å¤§æœƒ",
                        register_time: get_now_time(),
                        score_bottom: bottom_team_score,
                        score_top: top_team_score
                    }).then((result) => {
                        console.log("æˆåŠŸçš„çµæœï¼š", result);
                        if (result == undefined) {
                            show_message("é›²ç«¯ç™»è¨˜åˆ†æ•¸æˆåŠŸ")
                        }
                    })
                        .catch((error) => {
                            console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                            show_message("é›²ç«¯ç™»è¨˜åˆ†æ•¸å‡ºéŒ¯å•¦ï¼")
                        });
                }
            }
        })
        wait_to_register_list.splice(now_which_game, 1)
        show_message("å®Œæˆç™»è¨˜")
        idle_people_update_to_div()
        refresh_wait_to_register_text()
    }
    function handle_open_modal_of_record_score() {
        if (wait_to_register_list.length == 0) {
            return (alert("æ²’æœ‰éœ€è¦ç™»è¨˜çš„å ´æ¬¡"))
        }
        $("#which_game").empty()
        wait_to_register_list.forEach((obj, index) => {
            $("#which_game").append(`<option value="${index}">${todayPeople[obj[0] - 1].name} & ${todayPeople[obj[3] - 1].name} V.S. ${todayPeople[obj[1] - 1].name} ${todayPeople[obj[2] - 1].name} </option>`)
        })
        $("#player-1-td").html(todayPeople[wait_to_register_list[0][0] - 1].name)
        $("#player-2-td").html(todayPeople[wait_to_register_list[0][1] - 1].name)
        $("#player-3-td").html(todayPeople[wait_to_register_list[0][2] - 1].name)
        $("#player-4-td").html(todayPeople[wait_to_register_list[0][3] - 1].name)
        $("#which_game").change(handle_which_game_change)
        $('#myModal').modal('show');


    }
    function handle_which_game_change() {
        const now_which_game = parseInt($("#which_game").val())
        $("#player-1-td").html(todayPeople[wait_to_register_list[now_which_game][0] - 1].name)
        $("#player-2-td").html(todayPeople[wait_to_register_list[now_which_game][1] - 1].name)
        $("#player-3-td").html(todayPeople[wait_to_register_list[now_which_game][2] - 1].name)
        $("#player-4-td").html(todayPeople[wait_to_register_list[now_which_game][3] - 1].name)
    }

    function handle_clear_global_config() {
        global_config.albert_fisher = 0;
    }

    function handle_delete_record_score() {
        const now_which_game = parseInt($("#which_game").val())
        const confirmed = confirm(`ä½ ç¢ºå®šè¦åˆªé™¤${todayPeople[wait_to_register_list[now_which_game][0] - 1].name} & ${todayPeople[wait_to_register_list[now_which_game][3] - 1].name} V.S. ${todayPeople[wait_to_register_list[now_which_game][1] - 1].name} ${todayPeople[wait_to_register_list[now_which_game][2] - 1].name} é€™å€‹å°å±€çš„ç´€éŒ„å—ï¼Ÿ ä¸€èˆ¬åªåœ¨æŒ‰éŒ¯å ´æ¬¡ä¸Šå ´ è¶•å¿«æŒ‰ä¸‹ä¾† è¦æ¸…é™¤é€™å€‹éŒ¯èª¤ä½¿ç”¨ï¼`)
        if (confirmed) {
            wait_to_register_list.splice(now_which_game, 1)
            show_message("æˆåŠŸåˆªé™¤å ´æ¬¡ç´€éŒ„")
            $('#myModal').modal('hide');
            refresh_wait_to_register_text()
        }
    }

    function handle_backup_data_to_firebase() {
        //æœƒæŠŠè³‡æ–™å‚™ä»½åˆ°firebase 
        //å‚™ä»½ç›®æ¨™åœ°å€ backup_today_data
        // origin : serverç«¯
        // å‚™ä»½è³‡æ–™ ï¼štoday_people, game_record 
        // è³‡æ–™è¦å®Œæ•´ è«‹æŠŠæ‰€æœ‰æœªç™»è¨˜çš„åˆ†æ•¸å¡«å®Œ 
        database.ref(`Chung_Shan_elementary_school/backup_today_data/${get_now_time()}`).set({ todayPeople, game_record })
        show_message("å®Œæˆå‚™ä»½")
    }

    function refresh_wait_to_register_text() {
        $("#wait_to_register_text").html(`å¾…ç™»è¨˜: ${wait_to_register_list.length}`)
    }
    function handle_go_here() {
        //æ‰‹å‹•é»äººåˆ°æº–å‚™PKå€åŸŸä¸Š
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        if (choosed_people.length != 1) {
            return (show_message('æ­£åœ¨é¸æ“‡çš„äººæ•¸å¿…é ˆç‚º"1" æ“ä½œæ‰æœ‰æ•ˆ', "warning"))
        }
        if (prepare_PK.length != 4) {
            return (show_message('å¿…é ˆå…ˆæŒ‰é¸äºº æ“ä½œæ‰æœ‰æ•ˆ', "warning"))
        }
        //æª¢æŸ¥ æ‰‹å‹•æ´¾ä¸Šå ´çš„äºº æ˜¯ä¸æ˜¯ä¸åœ¨æº–å‚™PKå€ä¸Š
        if (prepare_PK.filter(obj => obj.id == choosed_people[0].id).length != 0) {
            return show_message("ä¸å¯ä»¥å°‡å·²ç¶“åœ¨æº–å‚™PKçš„äºº åœ¨æŒ‡å®šåˆ°å ´ä¸Š", "warning")
        }
        if (prepare_PK.filter(obj => obj.id == choosed_people[0].id).length != 0) {
            return show_message("ä¸å¯ä»¥å°‡å·²ç¶“åœ¨æº–å‚™PKçš„äºº åœ¨æŒ‡å®šåˆ°å ´ä¸Š", "warning")
        }
        const which_player = $(this).hasClass("player1") ? 1 : $(this).hasClass("player2") ? 2 : $(this).hasClass("player3") ? 3 : $(this).hasClass("player4") ? 4 : -1
        if (which_player == -1) {
            return (show_message('which_player ä¸å¯é æœŸçš„éŒ¯èª¤', "error"))
        }
        prepare_PK_refresh(choosed_people[0], which_player - 1)
        choosed_people[0].choosed = 0
        idle_people_update_to_div()
        put_todayPeople_to_court()
        show_message("æ›¿æ›æˆåŠŸ")
    }
    function handle_go_there() {
        //æ‰‹å‹•é»äººåˆ°æ¯”è³½å ´åœ°ä¸Š
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        if (choosed_people.length != 1) {
            return (show_message('æ­£åœ¨é¸æ“‡çš„äººæ•¸å¿…é ˆç‚º"1" æ“ä½œæ‰æœ‰æ•ˆ', "warning"))
        }
        //æª¢æŸ¥ æ‰‹å‹•æ´¾ä¸Šå ´çš„äºº æ˜¯ä¸æ˜¯ä¸åœ¨å…¶ä»–æ¯”è³½å ´ä¸Š
        //ä¸€èˆ¬å·²ç¶“åœ¨å ´ä¸Šçš„äºº ä¹Ÿä¸æœƒè¢«é¸æ“‡åˆ° æ‰€ä»¥ä¸æ‡‰è©²ç™¼ç”Ÿ
        if (todayPeople.filter(obj => obj.id == choosed_people[0] && obj.court != 0).length != 0) {
            return show_message("ä¸å¯ä»¥å°‡å·²ç¶“åœ¨å ´ä¸Šçš„äºº åœ¨æŒ‡å®šåˆ°å ´ä¸Š", "warning")
        }
        // if (prepare_PK.filter(obj => obj.id == choosed_people[0].id).length != 0) {
        //     return show_message("ä¸å¯ä»¥å°‡å·²ç¶“åœ¨æº–å‚™PKçš„äºº åœ¨æŒ‡å®šåˆ°å ´ä¸Š", "warning")
        // }
        const which_player = $(this).hasClass("player1") ? 1 : $(this).hasClass("player2") ? 2 : $(this).hasClass("player3") ? 3 : $(this).hasClass("player4") ? 4 : -1
        const which_court = $(this).hasClass("td-court-1") ? 1 : $(this).hasClass("td-court-2") ? 2 : $(this).hasClass("td-court-3") ? 3 : $(this).hasClass("td-court-4") ? 4 : -1
        if (which_player == -1) {
            return (show_message('which_player ä¸å¯é æœŸçš„éŒ¯èª¤', "error"))
        }
        if (which_court == -1) {
            return (show_message('which_court ä¸å¯é æœŸçš„éŒ¯èª¤', "error"))
        }
        let confirmed = confirm("ç¢ºèªåŸ·è¡Œæ›äººæ“ä½œå—ï¼Ÿ")
        if (!confirmed) {
            return
        }
        const replaced_person = todayPeople.filter(obj => obj.court == which_court && obj.player == which_player)[0]
        replaced_person.player = 0
        replaced_person.court = 0
        replaced_person.idleRounds = 0
        // prepare_PK_refresh(choosed_people[0], which_player - 1)
        todayPeople[choosed_people[0].id - 1].court = which_court
        todayPeople[choosed_people[0].id - 1].player = which_player
        choosed_people[0].choosed = 0
        idle_people_update_to_div()
        put_todayPeople_to_court()
        pickPeople()
        show_message("æ›¿æ›æˆåŠŸ")
    }
    function handle_upload_data_to_firebase() {
        //TODO: å¥½åƒæ²’å¿…è¦å­˜åœ¨...å†æƒ³æƒ³
        //prepare data
        const todayPeople_json = JSON.stringify(todayPeople);
        const empty_court_arr_json = JSON.stringify(empty_court_arr);
        const prepare_PK_json = JSON.stringify(prepare_PK);
        const game_record_json = JSON.stringify(game_record);
        const bulletin_board_message_json = JSON.stringify(bulletin_board_message);
        let today = new Date();
        let month = String(today.getMonth() + 1).padStart(2, '0');
        let date = String(today.getDate()).padStart(2, '0');
        let currentDate = month + date;
        write_today_data_to_firebase(todayPeople_json, game_record_json, bulletin_board_message_json, currentDate);
    }
    function get_now_time() {
        // å–ç•¶å‰æ™‚é–“åˆ°æ¯«ç§’
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const miliseconds = String(now.getMilliseconds()).padStart(2, '0');
        // åˆ›å»ºåŒ…å«å½“å‰æ—¶é—´çš„å­—ç¬¦ä¸²
        const currentTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}:${miliseconds}`;
        return (currentTime)
    }

    function reset_today_data_to_firebase() {
        //TODO: reset ä¹‹å‰æŠŠèˆŠè³‡æ–™æ”¾å…¥ä¸€å€‹è‡¨æ™‚å›æ”¶æ¡¶
        database.ref(`Chung_Shan_elementary_school/wait_to_register/`).set(
            "reset"
        )
        database.ref(`Chung_Shan_elementary_school/real_time_data/`).set(
            "reset"
        ).then((result) => {
            console.log("æˆåŠŸçš„çµæœï¼š", result);
            if (result == undefined) {
                show_message("é‡ç½®ä»Šæ—¥å³æ™‚è³‡æ–™æˆåŠŸ")
            }
        })
            .catch((error) => {
                console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                show_message("é‡ç½®ä»Šæ—¥å³æ™‚è³‡æ–™å¤±æ•—")
            });
    }
    function send_today_play_list_to_firebase(today_play_list) {
        //æ­¤è³‡æ–™å»ºç«‹ æ˜¯ç‚ºäº†è®“clientç«¯ å–å¾—ç•¶æ—¥çš„ä½¿ç”¨è€…ç™»å…¥åå–®
        database.ref(`Chung_Shan_elementary_school/today_play_list/`).set(
            today_play_list
        ).then((result) => {
            //æˆåŠŸçš„æ™‚å€™ æœƒè®“resultæ˜¯undefined
            if (result == undefined) {
                show_message("å¯«å…¥ä»Šæ—¥ä¸Šå ´äººå“¡è³‡æ–™æˆåŠŸ")
            }
        })
            .catch((error) => {
                console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
            });
    }
    function send_prepare_PK_to_firebase() {
        database.ref(`Chung_Shan_elementary_school/real_time_data/prepare_PK`).set(
            prepare_PK
        ).then((result) => {
            console.log("æˆåŠŸçš„çµæœï¼š", result);
            if (result == undefined) {
                show_message("å¯«å…¥æº–å‚™ä¸Šå ´äººå“¡è³‡æ–™æˆåŠŸ")
            }
        })
            .catch((error) => {
                console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                show_message("å¯«å…¥æº–å‚™ä¸Šå ´äººå“¡è³‡æ–™å¤±æ•— å¯èƒ½æ˜¯è³‡æ–™åº«å•é¡Œ", "error")
            });
    }
    function add_listener_to_client_do_from_firebase(database) {
        var userRef = database.ref('Chung_Shan_elementary_school/client_do/');
        userRef.on('value', (snapshot) => {
            const data = snapshot.val();
            console.log(data)
            if (data.action == 'check-in') {
                let action_person = todayPeople.filter(obj => obj.name == data.creater)
                if (action_person.length == 1) {
                    if (action_person[0].court != -1) {
                        show_message(`æ”¶åˆ°ç”¨æˆ¶ç«¯${action_person[0].name}çš„'å ±åˆ°'æ“ä½œ æ“ä½œå¤±æ•— 
                        å› ç‚ºä¸¦ä¸åœ¨ä¼‘æ¯å€ å¯èƒ½æ˜¯å·²ç¶“ä¸Šå ´ æˆ–æ˜¯å·²ç¶“åœ¨ç­‰å¾…å€äº†`, "client_error")
                    } else {
                        show_message(`æ”¶åˆ°ç”¨æˆ¶ç«¯${action_person[0].name}çš„'å ±åˆ°'æ“ä½œ æ“ä½œæˆåŠŸ`, "client_ok")
                        action_person[0].court = 0
                    }
                    idle_people_update_to_div()
                } else {
                    console.log(`æ”¶åˆ°ä¾†è‡ªç”¨æˆ¶ç«¯ ${data.creater} çš„'å ±åˆ°'æ“ä½œ ä½†æŸ¥ç„¡æ­¤äºº`, "client_error")
                }
            }
            if (data.action == 'go_to_sleep') {
                let action_person = todayPeople.filter(obj => obj.name == data.creater)
                if (action_person.length == 1) {
                    if (action_person[0].court != 0) {
                        show_message(`æ”¶åˆ°ç”¨æˆ¶ç«¯${action_person[0].name}çš„'å»ä¼‘æ¯å€'æ“ä½œ æ“ä½œå¤±æ•— 
                        å› ç‚ºä¸¦ä¸åœ¨ç­‰å¾…å€ å¯èƒ½æ˜¯å·²ç¶“ä¸Šå ´ æˆ–æ˜¯å·²ç¶“åœ¨ä¼‘æ¯å€äº†`, "client_error")
                    } else {
                        show_message(`æ”¶åˆ°ç”¨æˆ¶ç«¯${action_person[0].name}çš„'å»ä¼‘æ¯å€'æ“ä½œ æ“ä½œæˆåŠŸ`, "client_ok")
                        // action_person[0].court = -1
                        court_change(action_person[0], binding_team_list, -1)
                    }
                    idle_people_update_to_div()
                } else {
                    console.log(`æ”¶åˆ°ä¾†è‡ªç”¨æˆ¶ç«¯ ${data.creater} çš„'å»ä¼‘æ¯å€'æ“ä½œ ä½†æŸ¥ç„¡æ­¤äºº`, "client_error")
                }
            }
            if (data.action == 'go_to_wait') {
                let action_person = todayPeople.filter(obj => obj.name == data.creater)
                if (action_person.length == 1) {
                    if (action_person[0].court != -1) {
                        show_message(`æ”¶åˆ°ç”¨æˆ¶ç«¯${action_person[0].name}çš„'å»ç­‰å¾…å€'æ“ä½œ æ“ä½œå¤±æ•— 
                        å› ç‚ºä¸¦ä¸åœ¨ä¼‘æ¯å€ å¯èƒ½æ˜¯å·²ç¶“ä¸Šå ´ æˆ–æ˜¯å·²ç¶“åœ¨ç­‰å¾…å€äº†`, "client_error")
                    } else {
                        show_message(`æ”¶åˆ°ç”¨æˆ¶ç«¯${action_person[0].name}çš„'å»ç­‰å¾…å€'æ“ä½œ æ“ä½œæˆåŠŸ`, "client_ok")
                        action_person[0].court = 0
                    }
                    idle_people_update_to_div()
                } else {
                    console.log(`æ”¶åˆ°ä¾†è‡ªç”¨æˆ¶ç«¯ ${data.creater} çš„'å»ç­‰å¾…å€'æ“ä½œ ä½†æŸ¥ç„¡æ­¤äºº`, "client_error")
                }
            }
            if (data.action == 'register_score') {
                let action_person = todayPeople.filter(obj => obj.name == data.creater)
                if (action_person.length == 1) {
                    console.log(`æ”¶åˆ°ä¾†è‡ªç”¨æˆ¶ç«¯ ${action_person[0].name} çš„'ç™»è¨˜åˆ†æ•¸æ“ä½œ'æ“ä½œ`, "client_ok")
                    // è§£æè¦åˆ†æçš„åˆ†æ•¸ç™»è¨˜ æ˜¯å¦ç¬¦åˆç¾åœ¨çš„æœªç™»è¨˜æƒ…å½¢
                    const data_obj = JSON.parse(data.data)
                    console.log(data_obj)
                    let check_success = false
                    wait_to_register_list.forEach((obj, index) => {
                        const check1 = (data_obj[0] == todayPeople[obj[0] - 1].name)
                        const check2 = (data_obj[1] == todayPeople[obj[1] - 1].name)
                        const check3 = (data_obj[2] == todayPeople[obj[2] - 1].name)
                        const check4 = (data_obj[3] == todayPeople[obj[3] - 1].name)
                        if (check1 && check2 && check3 && check4) {
                            //æª¢æŸ¥æˆåŠŸ ç¢ºå¯¦æœ‰éœ€è¦ç™»è¨˜çš„å ´æ¬¡èˆ‡è³‡æ–™ç›¸ç¬¦
                            show_message(`æ”¶åˆ°ç™»è¨˜è³‡æ–™ä¸¦åŸ·è¡Œï¼š
                            ${data_obj[0]}  å’Œ ${data_obj[1]} å°ä¸Š ${data_obj[2]} å’Œ ${data_obj[3]}
                            åˆ†æ•¸ç‚º ${data_obj[4]} æ¯” ${data_obj[5]}`, "client_ok")
                            record_score(index, data_obj[4], data_obj[5])
                            check_success = true
                        }
                    })
                    if (check_success == false) {
                        show_message("æ”¶åˆ°ä¸å­˜åœ¨çš„å ´æ¬¡çš„åˆ†æ•¸ç™»è¨˜", "client_error")
                    }
                    idle_people_update_to_div()
                } else {
                    console.log(`æ”¶åˆ°ä¾†è‡ªç”¨æˆ¶ç«¯ ${data.creater} çš„'å»ç­‰å¾…å€'æ“ä½œ ä½†æŸ¥ç„¡æ­¤äºº`, "client_error")
                }
            }
            if (data.action == "off_court") {
                let action_person = todayPeople.filter(obj => obj.name == data.creater)
                if (action_person.length == 1) {
                    //æª¢æŸ¥è¦ä¸‹å ´çš„è³‡æ–™æ˜¯å¦æ­£ç¢º
                    console.log(data)
                    const court_number = data.data[0]
                    const player_name_list = data.data[1]
                    const server_player_list = todayPeople.filter(person => person.court == court_number).filter(person => player_name_list.includes(person.name))
                    if (server_player_list.length == 4) {
                        show_message(`æ”¶åˆ°ä¾†è‡ªä¾†è‡ªç”¨æˆ¶ç«¯ ${data.creater} çš„ä¸‹å ´è«‹æ±‚ è³‡æ–™é©—è­‰æˆåŠŸ åŸ·è¡Œä¸‹å ´`, "client_ok")
                        off_court_new(court_number)
                    } else {
                        show_message(`æ”¶åˆ°ä¾†è‡ªä¾†è‡ªç”¨æˆ¶ç«¯ ${data.creater} çš„ä¸‹å ´è«‹æ±‚ è³‡æ–™é©—è­‰å¤±æ•—`, "client_error")
                    }


                } else {
                    console.log(`æ”¶åˆ°ä¾†è‡ªç”¨æˆ¶ç«¯ ${data.creater} çš„'å»ç­‰å¾…å€'æ“ä½œ ä½†æŸ¥ç„¡æ­¤äºº`, "client_error")
                }

            }

        })
    }

    function handle_adjust_point_open_modal() {
        // èª¿æ•´åˆ†æ•¸æŒ‰éˆ• æœƒæ‰“é–‹modal 
        $('#adjust_score_select').empty()
        todayPeople.forEach(e => {
            $('#adjust_score_select').append(`<option value=${e.id}>${e.name} </option >`)
        })
        if (todayPeople.filter(e => e.choosed == 1).length == 1) {
            const choosed_person = todayPeople.filter(e => e.choosed == 1)[0]
            $('#adjust_score_select').val(choosed_person.id)
        }
        $('#adjust_score_Modal').modal('show');
    }

    function handle_adjust_point_confirm() {
        const person_id = parseInt($('#adjust_score_select').val())
        const target_point = parseInt($("#adjust_target_point_input").val())
        let confirmed = confirm(`ç¢ºå®šå°‡${todayPeople[person_id - 1].name}çš„åˆ†æ•¸èª¿æ•´ç‚º${target_point}åˆ†å—ï¼Ÿ`)
        if (confirmed) {
            todayPeople[person_id - 1].score = target_point
        }
        $('#adjust_score_Modal').modal('hide');
        idle_people_update_to_div()
    }
    function count_score_function(person, score, top_score_line, bottom_score_line) {
        // åˆ†æ•¸è¨ˆç®—è¦å‰‡ï¼š
        // é«˜æ–¼é«˜åˆ†ç·šçš„åˆ†æ•¸ å¢åŠ æœƒä»¥20%çš„æ¯”ä¾‹å¢åŠ (é™ä½æƒ…æ³æœƒæ­£å¸¸é™ä½)
        // ä½æ–¼ä½åˆ†ç·šçš„åˆ†æ•¸ æœƒè‡ªå‹•å›æ­¸ä½åˆ†ç·šçš„æ•¸å€¼
        if (score > 0) {
            if (person.score > top_score_line) {
                person.score = person.score + score / 5
                return
            }
            if (person.score + score > top_score_line) {
                person.score = parseInt(top_score_line + (person.score + score - top_score_line) / 5)
                return
            }
        }
        person.score = person.score + score
        if (person.score < bottom_score_line) {
            person.score = bottom_score_line
        }
        return
    }

    refresh_wait_to_register_text()
    idle_people_update_to_div()
    $("#pickPeople").on("click", pickPeople)
    $("#go_to_pk").on("click", go_to_PK)
    $(".gameEnd").on("click", handle_end_game_new)
    $("#check-info").on("click", handle_check_info)
    $("#refresh-idle").on("click", idle_people_update_to_div)
    $("#save-data").on("click", save_data)
    $("#prepare_to_delete").on("click", prepare_to_delete)
    $("#hide_score").on("change", handle_hide_score_change)
    $("#score_count").on("change", handle_score_count_change)
    $("#simplify_do").on("change", handle_simplify_do_change)
    $("#off_court_check").on("change", handle_off_court_check_change)
    $("#show_game_record").on('click', handle_show_game_record)
    $("#set_personal_record").on('click', handle_set_personal_record)
    $("#set_personal_record").on('click', handle_set_personal_record)
    $("#delete_today_data").on('click', handle_delete_today_data)
    $("#binding").on("click", handle_binding)
    $("#go_to_sleep").on("click", handle_go_to_sleep)
    $("#go_to_wait").on("click", handle_go_to_wait)
    $("#cancel_binding").on("click", handle_cancel_binding)
    $("#cancel_choosed").on("click", handle_cancel_choosed)
    $("#record_score").on("click", handle_record_score)
    $("#open_modal_of_record_score").on("click", handle_open_modal_of_record_score)
    $("#delete_record_score").on("click", handle_delete_record_score)
    $(".go_here").click(handle_go_here)
    $("#one_click_to_wait").click(handle_one_click_to_wait)
    $("#adjust_point").click(handle_adjust_point_open_modal)
    $("#adjust_point_confirm_button").click(handle_adjust_point_confirm)


    $("#upload_data_to_firebase").click(handle_upload_data_to_firebase)

    $("#clear_global_config").click(handle_clear_global_config)

    add_listener_to_client_do_from_firebase(database)

    $("#backup_data_to_firebase").click(handle_backup_data_to_firebase)
    $(".td-click").click(handle_go_there)


    //é€šå¸¸æ•´å¤©çµæŸçš„æ™‚å€™ ä½¿ç”¨é€™å€‹åŠŸèƒ½ é€™å€‹ä¸Šå‚³çš„è³‡æ–™æœƒæ°¸ä¹…ä¿å­˜ (æŒ‰æ—¥æœŸç®—) 
    function write_today_data_to_firebase(today_people_data, game_record_data, bulletin_board_message_data, today_date) {
        database.ref(`Chung_Shan_elementary_school/Tuesday/date_${today_date}/`).set({
            today_people: today_people_data,
            game_record: game_record_data,
            bulletin_board_message: bulletin_board_message_data
        }).then((result) => {
            console.log("æˆåŠŸçš„çµæœï¼š", result);
            if (result == undefined) {
                show_message("å¯«å…¥è³‡æ–™æˆåŠŸ(ä¸Šå‚³ç•¶æ—¥ç¸½è³‡æ–™)")
            }
        })
            .catch((error) => {
                console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                show_message("ç™¼ç”ŸéŒ¯èª¤ï¼šwrite_today_data_to_firebase", "error")
            });
    }
    //ä¸Šå‚³wait_to_registeråˆ°firebase è®“clientç«¯å¯ä»¥æŸ¥çœ‹ç™»è¨˜ 
    //ä¸Šå‚³æ™‚æ©Ÿç‚º çµæŸæ¯”è³½æ™‚ï¼ˆæ¯”è³½çµæŸæŒ‰éˆ•æŒ‰ä¸‹å»æ™‚ï¼‰
    function upload_wait_to_register_to_firebase(name_list) {
        database.ref(`Chung_Shan_elementary_school/wait_to_register/${get_now_time()}`).set({
            player1: name_list[0],
            player2: name_list[1],
            player3: name_list[2],
            player4: name_list[3],
            create_time: get_now_time(),
            score_top: "å¾…ç™»è¨˜",
            score_bottom: "å¾…ç™»è¨˜",
            register_name: "å¾…ç™»è¨˜",
            register_time: "å¾…ç™»è¨˜"
        }
        ).then((result) => {
            console.log("æˆåŠŸçš„çµæœï¼š", result);
            if (result == undefined) {
                show_message("å¯«å…¥è³‡æ–™æˆåŠŸ(å¾…ç™»è¨˜è³‡æ–™)")
            }
        })
            .catch((error) => {
                console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                show_message("ç™¼ç”ŸéŒ¯èª¤ï¼šupload_wait_to_register_to_firebase")
            });
    }
    //ç›®å‰æ˜¯æ”¾åœ¨idle_people_update_to_div()è£¡é¢
    // å¯èƒ½è¦è¦–æƒ…æ³èª¿æ•´ä¸Šå‚³æ™‚æ©Ÿ ä»¥é¿å…ä½¿ç”¨é‡éå¤§ æ¯æ—¥å…è²»é…é¡360MB
    function upload_real_time_data_to_firebase() {
        database.ref(`Chung_Shan_elementary_school/real_time_data`).set({
            todayPeople: todayPeople,
            prepare_PK: prepare_PK,
            wait_to_register_list: wait_to_register_list
        }
        ).then((result) => {
            console.log("æˆåŠŸçš„çµæœï¼š", result);
            if (result == undefined) {
                show_message("å¯«å…¥è³‡æ–™æˆåŠŸ(å³æ™‚è³‡æ–™)")
            }
        })
            .catch((error) => {
                console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                show_message("ç™¼ç”ŸéŒ¯èª¤ï¼šupload_real_time_data_to_firebase")
            });
    }
    function upload_real_time_data_todayPeople_to_firebase() {
        database.ref(`Chung_Shan_elementary_school/real_time_data/todayPeople`).set(
            todayPeople
        ).then((result) => {
            console.log("æˆåŠŸçš„çµæœï¼š", result);
            if (result == undefined) {
                show_message("å¯«å…¥è³‡æ–™æˆåŠŸ(å³æ™‚è³‡æ–™-ä»Šæ—¥äººå“¡è³‡æ–™)")
            }
        })
            .catch((error) => {
                console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
                show_message("upload_real_time_data_todayPeople_to_firebase", "error")
            });
    }

</script>

<script>
    //è¨ˆç®—é¸äººä¸Šå ´é‚è¼¯
    function isOverlap(choice1, choice2) {
        const set1 = new Set(choice1["è™Ÿç¢¼æ¸…å–®"]);
        const set2 = new Set(choice2["è™Ÿç¢¼æ¸…å–®"]);
        const intersection = [...set1].filter((x) => set2.has(x));
        return intersection.length > 0;
    }

    function fourIdsFormAMatch(peopleReadyFight, ids, binding = [], match_type = 'æœªè¨­å®š') {
        let sortedFourPeople = [];
        if (binding.length === 2) {
            // console.log('peopleReadyFight', peopleReadyFight);
            // console.log('ç¬¬1', sortedFourPeople);
            for (const id of ids) {
                for (const person of peopleReadyFight) {
                    if (person.id === id) {
                        sortedFourPeople.push(person);
                        break;
                    }
                }
            }
            sortedFourPeople.push(sortedFourPeople.shift());
        } else {
            // console.log('ç¬¬2', sortedFourPeople);
            const theFourPeople = peopleReadyFight.filter((person) =>
                ids.includes(person.id)
            );
            sortedFourPeople = theFourPeople.sort(
                (a, b) => b.score - a.score
            );
        }
        // console.log('ç¬¬ä¸‰', sortedFourPeople);
        const std = Math.round(
            math.std(sortedFourPeople.map((person) => person.score))
        );

        const waitNum = peopleReadyFight
            .filter((person) => ids.includes(person.id))
            .reduce((total, person) => total + Math.pow(3, person.idleRounds), 0);

        return {
            "è©•åˆ†": waitNum - std,
            "å°æˆ°é¡å‹": match_type,
            "1è™Ÿæˆ°åŠ›": sortedFourPeople[0].score,
            "2è™Ÿæˆ°åŠ›": sortedFourPeople[1].score,
            "3è™Ÿæˆ°åŠ›": sortedFourPeople[2].score,
            "4è™Ÿæˆ°åŠ›": sortedFourPeople[3].score,
            "æˆ°åŠ›": `${sortedFourPeople[0].score + sortedFourPeople[3].score} vs ${sortedFourPeople[1].score + sortedFourPeople[2].score
                }`,
            "ç¸½åˆ†": sortedFourPeople.reduce((total, person) => total + person.score, 0),
            "éšŠä¼å·®": Math.abs(
                (sortedFourPeople[0].score + sortedFourPeople[3].score) -
                (sortedFourPeople[1].score + sortedFourPeople[2].score)
            ),
            "æ¨™æº–å·®": std,
            "çµ„å…§å·®": Math.max(
                Math.abs(sortedFourPeople[0].score - sortedFourPeople[3].score),
                Math.abs(sortedFourPeople[1].score - sortedFourPeople[2].score)
            ),
            "1è™Ÿ": sortedFourPeople[0].id,
            "2è™Ÿ": sortedFourPeople[1].id,
            "3è™Ÿ": sortedFourPeople[2].id,
            "4è™Ÿ": sortedFourPeople[3].id,
            "è™Ÿç¢¼æ¸…å–®": sortedFourPeople.map((person) => person.id),
            "ç­‰å¾…å€¼": waitNum,

        };
    }
    function letsPlay(people, partner) {
        console.log("ç¶å®šæ¸…å–®", partner)
        const flatten_partner = partner.flat();

        // step1: Get the list of people ready to fight

        const people_ready_fight = people.filter(person => person.court === 0);
        const ids_people_ready_fight = people_ready_fight.map(person => person.id)
        const people_ready_fight_single = people_ready_fight.filter(person => !flatten_partner.includes(person.id));
        const ids_people_ready_fight_single = people_ready_fight_single.map(person => person.id)

        const matches = [];
        console.log(' people', people);
        console.log(' people_ready_fight', people_ready_fight);
        console.log(' ids_people_ready_fight', ids_people_ready_fight);

        const sorted_people_ready_fight_single = people_ready_fight_single.sort((person1, person2) => person1.score - person2.score);
        const ids_sorted_people_ready_fight_single = sorted_people_ready_fight_single.map(person => person.id)
        console.log(' people_ready_fight_single', people_ready_fight_single);
        console.log(' ids_people_ready_fight_single', ids_people_ready_fight_single);
        // step2: Enumerate acceptable matches
        for (let i = 0; i < sorted_people_ready_fight_single.length - 3; i++) {
            const ids = sorted_people_ready_fight_single.slice(i, i + 4).map(person => person.id);
            console.log('ids1533', ids);
            matches.push(fourIdsFormAMatch(sorted_people_ready_fight_single, ids, [], match_type = 'å…¨éƒ¨å–®äºº'));
        }
        console.log('basic_matches[0]', matches[0]);
        console.log('basic_matches[1]', matches[1]);
        console.log('basic_matches', matches);
        console.log('basic_matches[0]', matches[0]);
        console.log('basic_matches[1]', matches[1]);
        let all_two_binding = []
        for (const binding of partner) {
            const length_binding = binding.length;
            if (!ids_people_ready_fight.includes(binding[0])) {
                continue;
            } else if (length_binding === 2) {
                all_two_binding.push(binding)
                const matches_for_2 = [];
                let match_temp = [...binding];

                for (let i = 0; i < people_ready_fight.length; i++) {
                    for (let j = 0; j < people_ready_fight.length; j++) {
                        const person1 = people_ready_fight[i];
                        const person2 = people_ready_fight[j];

                        // console.log('per1', person1);
                        // console.log('per2', person2);
                        if (
                            i >= j ||
                            match_temp.includes(person1.id) ||
                            match_temp.includes(person2.id) ||
                            flatten_partner.includes(person1.id) ||
                            flatten_partner.includes(person2.id)
                        ) {
                            // console.log('AA');
                            continue;
                        } else {
                            // console.log('BB');
                            match_temp.push(person1.id);
                            match_temp.push(person2.id);
                            // console.log('match_temp', match_temp);
                            // console.log('binding',binding);
                            const a_match_dict = fourIdsFormAMatch(people_ready_fight, match_temp, binding, match_type = 'é›™äººç¶å®š');
                            matches_for_2.push(a_match_dict);
                            match_temp = [...binding];
                        }
                    }
                }

                if (matches_for_2.length === 0) {
                    console.log('æ²’æœ‰é…åˆ°ï¼ï¼ï¼');
                }

                const sorted_matches_for_2 = matches_for_2.sort((match1, match2) => match1.æ¨™æº–å·® - match2.æ¨™æº–å·®);
                matches.push(sorted_matches_for_2[0]);
            } else if (length_binding === 3) {
                const matches_for_3 = [];
                let match_temp = [...binding];

                for (let i = 0; i < people_ready_fight.length; i++) {
                    const person1 = people_ready_fight[i];

                    if (match_temp.includes(person1.id) || flatten_partner.includes(person1.id)) {
                        continue;
                    } else {
                        match_temp.push(person1.id);
                    }

                    const a_match_dict = fourIdsFormAMatch(people_ready_fight, match_temp, [], match_type = 'ä¸‰äººç¶å®š');
                    matches_for_3.push(a_match_dict);
                    match_temp = [...binding];
                }

                const sorted_matches_for_3 = matches_for_3.sort((match1, match2) => match1.æ¨™æº–å·® - match2.æ¨™æº–å·®);
                const min_team_diff = Math.min(...sorted_matches_for_3.map(match => match.éšŠä¼å·®));
                const min_team_diff_match = sorted_matches_for_3.filter(match => match.éšŠä¼å·® === min_team_diff);
                const min_sd = Math.min(...min_team_diff_match.map(match => match.æ¨™æº–å·®));

                for (const match of min_team_diff_match) {
                    if (match.éšŠä¼å·® === min_team_diff && match.æ¨™æº–å·® === min_sd) {
                        if (!matches.includes(match)) {
                            matches.push(match);
                        }
                        break;
                    }
                }
            } else if (length_binding === 4) {
                const match_temp = [...binding];
                const a_match_dict = fourIdsFormAMatch(people_ready_fight, match_temp, [], match_type = 'å››äººç¶å®š');
                matches.push(a_match_dict);
            }
        }

        console.log('all_two', all_two_binding);
        for (const binding_1 of all_two_binding) {
            for (const binding_2 of all_two_binding) {
                if (binding_1 != binding_2) {
                    let binding_temp = []
                    binding_temp.push(...binding_1)
                    binding_temp.push(...binding_2)
                    console.log('æ‰¾åˆ°é›™çµ„', binding_temp)
                    matches.push(fourIdsFormAMatch(people_ready_fight, binding_temp, binding_1, match_type = 'å…©çµ„å°æˆ°'));


                }
            }
        }
        // step3: Sort matches
        const sorted_matches = matches.sort((match1, match2) => match2.è©•åˆ† - match1.è©•åˆ†);

        // step4: Combinations of matches
        const solutions = [];

        for (let i = 0; i < sorted_matches.length; i++) {
            const choice_1 = sorted_matches[i];

            for (let j = 0; j < sorted_matches.length; j++) {
                const choice_2 = sorted_matches[j];

                if (j <= i) {
                    continue;
                }

                if (!isOverlap(choice_1, choice_2)) {
                    solutions.push({
                        è©•åˆ†S: choice_1.è©•åˆ† + choice_2.è©•åˆ†,
                        è©•åˆ†1: choice_1.è©•åˆ†,
                        è©•åˆ†2: choice_2.è©•åˆ†,
                        Choice_1: i,
                        Choice_2: j,
                        SD_1: choice_1.æ¨™æº–å·®,
                        SD_2: choice_2.æ¨™æº–å·®,
                        SD_ALL: choice_1.æ¨™æº–å·® + choice_2.æ¨™æº–å·®,
                        ç­‰å¾…å€¼1: choice_1.ç­‰å¾…å€¼,
                        ç­‰å¾…å€¼2: choice_2.ç­‰å¾…å€¼,
                        ç­‰å¾…å€¼S: choice_1.ç­‰å¾…å€¼ + choice_2.ç­‰å¾…å€¼,
                        ç­‰å¾…å ´æ¬¡1: people_ready_fight
                            .filter(person => choice_1.è™Ÿç¢¼æ¸…å–®.includes(person.id))
                            .map(person => person.idleRounds),
                        ç­‰å¾…å ´æ¬¡2: people_ready_fight
                            .filter(person => choice_2.è™Ÿç¢¼æ¸…å–®.includes(person.id))
                            .map(person => person.idleRounds),
                    });
                }
            }
        }
        console.log('sorted_matches', sorted_matches);
        if (solutions.length < 1) {
            console.log('sorted_matches[0]', sorted_matches[0]);
            return sorted_matches[0].è™Ÿç¢¼æ¸…å–®;
        } else {
            // step5: Sort solutions by 'è©•åˆ†S'
            const sorted_solutions = solutions.sort((sol1, sol2) => sol2.è©•åˆ†S - sol1.è©•åˆ†S);
            console.log('solutions', solutions);
            console.log('solutions[0]', solutions[0]);
            console.log('solutions[1]', solutions[1]);
            // step6: Find the choice with the highest 'è©•åˆ†S' and 'è©•åˆ†'
            const the_choice = Math.max(solutions[0].è©•åˆ†1, solutions[0].è©•åˆ†2);

            console.log('sorted_solutions', sorted_solutions);
            if (solutions[0].è©•åˆ†1 > solutions[0].è©•åˆ†2) {
                console.log('sorted_matches[solutions[0].Choice_1]', sorted_matches[solutions[0].Choice_1]);
                return sorted_matches[solutions[0].Choice_1].è™Ÿç¢¼æ¸…å–®;
            } else {
                console.log('sorted_matches[solutions[0].Choice_2]', sorted_matches[solutions[0].Choice_2]);
                return sorted_matches[solutions[0].Choice_2].è™Ÿç¢¼æ¸…å–®;
            }
        }
    }


</script>
<script>
    function pick_weight_count(today_people, binding_list) {
        // IDLE ROUND WEIGHT æ˜¯æ¬¡æ–¹é—œä¿‚  ç­‰äº†4å ´ æœƒæ‰£5*5*5*5åˆ† (è¶Šä½åˆ†è¶Šå„ªå…ˆä¸Š)
        const idle_round_weight = 5
        //count_d_weight æ˜¯é›™æ–¹çš„åˆ†å·® èˆ‰ä¾‹ ä¸€é‚Šæ˜¯150+200 å¦ä¸€é‚Šæ˜¯50+500 åˆ†å·®ç‚º200 æœƒåœ¨*æ¬Šé‡åŠ ä¸Šå»(è¶Šé«˜åˆ†è¶Šä¸å®¹æ˜“ä¸Šå ´)
        const count_d_weight = 10
        //count_player_in_one_team_weight æ˜¯éšŠå…§çš„åˆ†å·® ä¸€èˆ¬å¸Œæœ›è¶Šå°è¶Šå¥½ ä½†æ˜¯å…©éšŠå·®è·å°æ›´é‡è¦ æ‰€ä»¥æ¬Šé‡æ‡‰ä½æ–¼ é›™æ–¹çš„åˆ†å·® 
        const count_player_in_one_team_weight = 1
        // binding_l_p æ˜¯çµ¦ä¸ç¬¦åˆç¶å®šè¦å‰‡çš„äººå·¨å¤§çš„åˆ†æ•¸ è®“ä¸åˆè¦å‰‡çš„çµ„åˆå¹¾ä¹ä¸æœƒä¸Šå ´
        const match = []
        const data = today_people.filter(person => person.court == 0)
        const all_people_number = data.length
        for (let player1 = 0; player1 < all_people_number; player1++) {
            for (let player2 = player1 + 1; player2 < all_people_number; player2++) {
                if (player1 == player2) {
                    continue;
                }
                for (let player3 = player2 + 1; player3 < all_people_number; player3++) {
                    if (player1 == player3 || player2 == player3) {
                        continue;
                    }
                    for (let player4 = player1 + 1; player4 < all_people_number; player4++) {
                        if (player1 == player4 || player2 == player4 || player3 == player4) {
                            continue;
                        }
                        const count_d = count_difference([data[player1], data[player2], data[player3], data[player4]]) * count_d_weight
                        const count_p14 = Math.abs(data[player1].score - data[player4].score) * count_player_in_one_team_weight
                        const count_p23 = Math.abs(data[player2].score - data[player3].score) * count_player_in_one_team_weight
                        const idleRounds_C = idleRounds_count([data[player1], data[player2], data[player3], data[player4]], idle_round_weight)
                        const binding_l_p = binding_list_point([data[player1].id, data[player2].id, data[player3].id, data[player4].id], binding_list)
                        match.push([data[player1], data[player2], data[player3], data[player4], count_d + count_p14 + count_p23 - idleRounds_C + binding_l_p, count_d, count_p14, count_p23, idleRounds_C, binding_l_p])
                    }
                }
            }
        }
        // console.log(match)
        const match_sort = match.sort((a, b) => { return a[4] - b[4] })
        console.log(new Date())
        console.log(match_sort.slice(0, 10))
        return ([match_sort[0][0].id, match_sort[0][1].id, match_sort[0][2].id, match_sort[0][3].id])
    }
    function count_teammates_difference(teammates_list) {
        //è¨ˆç®—çµ„å…§å·®è· å‚³å…¥çš„åƒæ•¸ æ‡‰è©²ç‚ºä¸€å€‹list è£¡é¢æœ‰todaypeopleè£¡çš„äººå…©å€‹
        //ç•¶è¶…é200 æœƒå°‡é€™å€‹åƒæ•¸æ”¾å¤§15å€ 
        const temp = Math.abs(teammates_list[0].score + teammates_list[1].score)
        return temp > 200 ? temp * 15 : temp;
    }
    function count_difference(a) {
        //è¨ˆç®—ï½ï½‹çš„å…©å€‹éšŠä¼çš„åˆ†æ•¸åˆè¨ˆå·®è·  å‚³å…¥çš„åƒæ•¸ æ‡‰è©²ç‚ºä¸€å€‹list è£¡é¢æœ‰todaypeopleè£¡çš„äºº4å€‹ 
        // é€™å››å€‹äººç•¶ä¸­ 1ï¼†4 åŒä¸€éšŠ 2ï¼†3 åŒä¸€éšŠ
        //ç•¶è¶…é200 æœƒå°‡é€™å€‹åƒæ•¸æ”¾å¤§1.5å€
        const temp = Math.abs(a[0].score + a[3].score - a[1].score - a[2].score)
        return temp > 200 ? temp * 1.5 : temp;
    }
    function idleRounds_count(a, p = 10) {
        // è¨ˆç®—ç•¶å‰çš„ç­‰å¾…å ´æ•¸çš„åˆ†æ•¸æ›ç®— ä»¥ç­‰æ¯”æ•¸åˆ—çš„æ–¹å¼æˆé•· 
        // æœ‰æœ€å¤§å€¼50000 (ç”¨æ‰£çš„ æ‰€ä»¥ç•¶é”åˆ°æœ€å¤§å€¼æ™‚ æœƒå¾ˆå®¹æ˜“ä¸Šå ´)
        const point = Math.pow(p, a[0].idleRounds) + Math.pow(p, a[1].idleRounds) + Math.pow(p, a[2].idleRounds) + Math.pow(p, a[3].idleRounds)
        return point > 50000 ? 50000 : point
    }
    function binding_list_point(a, binding_list) {
        // è¨ˆç®— æ˜¯å¦ç‚ºç¶å®šçµ„åˆçš„åˆ†æ•¸ 
        // å¦‚æœä¸ç¬¦åˆç¶å®šçš„è¦å‰‡ æœƒæœ‰100è¬åˆ† è®“é€™å€‹çµ„åˆåŸºæœ¬ä¸Šä¸€å®šä¸æœƒè¢«é¸åˆ°
        let num = 0
        a.forEach(element => {
            binding_list.forEach(binding => {
                if (binding.includes(element)) {
                    binding.forEach(be => {
                        if (!a.includes(be)) {
                            num = 999999
                        }
                        if (binding.length == 2) {
                            var index1 = a.indexOf(binding[0]);
                            var index2 = a.indexOf(binding[1]);
                            if (index1 + index2 != 3) {
                                num = 999999
                            }
                        }
                    })
                }
            })
        });

        return num
    }

</script>
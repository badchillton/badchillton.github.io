<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>å’Œé›²ç¾½chillç¤¾ </title>
    <!-- å¼•å…¥ Bootstrap çš„ CSS æª”æ¡ˆ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        div {
            overflow-x: scroll;
        }

        .even {
            background-color: rgb(122, 176, 223);
        }

        .odd {
            background-color: antiquewhite;
        }

        .court {
            background-color: rgb(236, 236, 244);
            border: 2px solid white;
            /* overflow-x: scroll; */
        }

        .row>div {
            padding: 5px;
        }

        .court td {
            /* margin-top: 10px; */
            height: 120px;
        }

        .court .net {
            background-color: aliceblue;
            height: 5px;
        }

        .container {
            background-color: gray;
        }

        .gameStart {
            background-color: greenyellow;
            width: 45%;
        }

        .gameEnd {
            background-color: red;
            width: 45%;
            color: aliceblue;
        }

        .person-span {
            margin: 3px;
            border: 1px solid black;
            /* background-color: white; */
        }

        .court-5 {
            background-color: burlywood;
        }

        .court-1 {
            /* background-color: lightgreen; */
            background-color: MediumSeaGreen;
        }

        .court-2 {
            background-color: lightgreen;
        }

        .court-3 {
            /* background-color: lightgreen; */
            background-color: MediumSeaGreen;
        }

        .court-4 {
            background-color: lightgreen;
            /* background-color: lightyellow; */
        }

        .analysis td {
            height: auto;
        }

        .personal_table {
            background-color: aliceblue;
            margin: 2px;
            border-radius: 3px;
        }

        .json {
            width: 100%;
        }

        .gameEnd {
            display: none;
        }

        .gameStart {
            display: none;
        }

        .person-wait {
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="user_account" hidden>
            <input type="text" id="user_name">
            <button id="user_register">è¨»å†Š</button>
            <button id="user_login">ç™»å…¥</button>

        </div>
        <div class="row court-container">
            <div class="col-2">
                <h2>å³å°‡ä¸Šå ´</h2>
                <table class="table table-bordered court-5 court">
                    <tr>
                        <td class="player1"></td>
                        <td class="player4"></td>
                    </tr>
                    <tr>
                        <td class='net'> </td>
                        <td class='net'> </td>
                    </tr>
                    <tr>
                        <td class="player2"></td>
                        <td class="player3"></td>
                    </tr>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col-4">
                <h1>æˆ°ç¸¾è¡¨</h1>
                <table id="game_record" class="table-bordered"></table>
            </div>
            <div class="col-8">
                <h1> å‚™æˆ°å€</h1>
                <div class="row person-wait"></div>
                <h1> ä¼‘æ¯å€</h1>
                <div class="row person-sleep"></div>
                <div id="bulletin_board">
                    <h1>ğŸ“°å…¬å¸ƒæ¬„ğŸ“°</h1>
                    <div id="bulletin_board_message"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <table id="game_record" class="table-bordered"></table>
            </div>
        </div>

    </div>

    <!-- å¼•å…¥ jQuery å’Œ Bootstrap çš„ JS æª”æ¡ˆ -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>

<script>
    //é€™å››å€‹è®Šæ•¸æœƒå¯«å…¥local storage
    let todayPeople = [];
    let prepare_PK = [];
    let empty_court_arr = [1, 2, 3, 4];
    let game_record = [];
    let bulletin_board_message = []
    //é€™ä¸‰å€‹è®Šæ•¸ æ¯æ¬¡é€²ä¾†æœƒé‡ç½®æˆé€™æ¨£
    let min_idle = 0;
    let hide_score = '1';
    let score_count = '0';
    //ç”¢ç”Ÿ4å€‹ä¸»è¦æ¯”è³½å ´åœ°
    for (let i = 1; i < 5; i++) {
        $(".court-container").append(court_generate(i))
    }
    $(".court-container").append(`<div class='col-2'><h1>æˆ‘<br>æ˜¯<br>è¬›<br>å°</h1><div>`)
    //å¾local storage è¼‰å…¥è³‡æ–™ è‹¥æ²’æœ‰è³‡æ–™å‰‡ç”¢ç”Ÿå‡è³‡æ–™
    if (!load_data()) {
        for (let i = 1; i <= 28; i++) {
            todayPeople.push({ id: i, name: `Object ${i}`, score: 500 - i, court: 0, idleRounds: 0, player: 0, partner_id: 0 });
        }
    }
    function personal_card(person) {
        // <br>âš”ï¸ï¼š${hide_score == 1 ? '???' : person.score}
        return (`<span style="writing-mode: vertical-rl;">${person.name}<span>`)
    }
    function show_player_data_to_court(topTeamPlayers, bottomTeamPlayers, court) {
        //topTeamPlayers, bottomTeamPlayers éƒ½æ˜¯array æ”¾äº†å…©å€‹é¸æ‰‹çš„è³‡æ–™
        //court æ˜¯ int è¡¨ç¤ºç¬¬å¹¾å ´æ¬¡
        console.log(topTeamPlayers)
        console.log("flag")
        $(`.court-${court} .player1`).html(personal_card(topTeamPlayers[0]))
        $(`.court-${court} .player2`).html(personal_card(bottomTeamPlayers[0]))
        $(`.court-${court} .player3`).html(personal_card(bottomTeamPlayers[1]))
        $(`.court-${court} .player4`).html(personal_card(topTeamPlayers[1]))
        $(`.net-left-${court}`).html(`â†‘ï¼š${topTeamPlayers[0].score + topTeamPlayers[1].score}`)
        $(`.net-right-${court}`).html(`â†“ï¼š${bottomTeamPlayers[0].score + bottomTeamPlayers[1].score}`)
    }
    function empty_data_to_court(court) {
        $(`.court-${court} .player1`).empty()
        $(`.court-${court} .player2`).empty()
        $(`.court-${court} .player3`).empty()
        $(`.court-${court} .player4`).empty()
        $(`.analysis-${court} .top`).empty()
        $(`.analysis-${court} .bottom`).empty()
    }
    function court_generate(court_number) {
        return (`<div class="col-2">
            <h2>${court_number}è™Ÿå ´</h2>
                <table class="table table-bordered court-${court_number} court">
                    <tr>
                        <td class="player1"></td>
                        <td class="player4"></td>
                    </tr>
                    <tr>
                        <td class='net net-left-${court_number}'> </td>
                        <td class='net net-right-${court_number}'> </td>
                    </tr>
                    <tr>
                        <td class="player2"></td>
                        <td class="player3"></td>
                    </tr>
                </table>
                
            </div>`)
    }
    function auto_choose_players(allPlayers) {
        //å°‡å…¨éƒ¨äººå“¡çš„è³‡æ–™è¼¸å…¥ 
        //å…ˆæ‰¾å‡ºä¸åœ¨å ´æ¯”è³½çš„äºº
        const result = allPlayers.filter(obj => obj.court === 0);
        // æ‰¾å‡º idleRounds æœ€é«˜çš„äºº
        const oldestPerson = result.reduce((prev, current) => {
            return (prev.idleRounds > current.idleRounds) ? prev : current;
        });
        // æ‰¾å‡ºå’Œé€™å€‹äºº score æœ€æ¥è¿‘çš„å…¶ä»–ä¸‰äºº
        let otherPeople = result.filter(person => person.name !== oldestPerson.name && person.idleRounds >= min_idle);
        if (otherPeople.length < 3) {
            otherPeople = result.filter(person => person.name !== oldestPerson.name && person.idleRounds >= 0);
        }
        otherPeople.sort((a, b) => {
            const diffA = Math.abs(a.score - oldestPerson.score);
            const diffB = Math.abs(b.score - oldestPerson.score);
            return diffA - diffB;
        });
        const closestPeople = otherPeople.slice(0, 3);
        // é‡çµ„é™£åˆ—
        const combinedArray = [oldestPerson, ...closestPeople];
        // æŒ‰ç…§åˆ†æ•¸é«˜ä½æ’åº
        combinedArray.sort((a, b) => b.score - a.score);
        return combinedArray
    }
    function pickPeople() {
        console.log(auto_choose_players(todayPeople))
        const pickedPeople = auto_choose_players(todayPeople)
        prepare_PK_refresh(pickedPeople)
        show_player_data_to_court([pickedPeople[0], pickedPeople[3]], [pickedPeople[1], pickedPeople[2]], 5)

    }
    function prepare_PK_refresh(pickedPeople) {
        prepare_PK = pickedPeople
    }
    function go_to_PK() {
        //æŠŠè³‡æ–™æ”¹ä¸Šå» ä¸¦é¡¯ç¤ºäººå“¡åœ¨å°çš„ä½ç½®
        if (empty_court_arr.length == 0) {
            alert("ç¾åœ¨æ²’æœ‰ç©ºå ´ ç„¡æ³•é€²è¡Œæ¯”è³½")
        } else {
            const court = empty_court_arr.length > 0 ? empty_court_arr[0] : 0
            if (prepare_PK.length != 4) {
                return (alert("è«‹å…ˆé¸äºº å†å»PK"))
            }
            prepare_PK.forEach((person, index) => {
                person.court = court;
                person.player = index + 1
            });
            show_player_data_to_court([prepare_PK[0], prepare_PK[3]], [prepare_PK[1], prepare_PK[2]], court)
            empty_court_arr.shift()
            prepare_PK = [];
            empty_data_to_court(5)
            todayPeople.forEach(person => {
                if (person.court == 0) {
                    person.idleRounds += 1;
                } else {
                    person.idleRounds = 0;
                }
            })
            idle_people_update_to_div()
        }

    }
    function idle_people_update_to_div() {
        const idle_people = todayPeople.filter(obj => obj.court === 0).sort((a, b) => b.idleRounds - a.idleRounds)
        $(".person-wait").empty()
        for (x in idle_people) {
            if (idle_people[x].idleRounds < 0) {
                $(".person-sleep").append(idle_personal_card(idle_people[x]))
            } else {
                $(".person-wait").append(idle_personal_card(idle_people[x]))
            }
        }
    }
    function idle_personal_card(person) {
        return (`
        <table class='personal_table table-bordered'> 
            <tr>
                <td>${person.name}</td>
            </tr>
            <tr>
                <td>${hide_score == 1 ? '???' : person.score}</td>
            </tr>
            <tr>
                <td>${person.idleRounds}</td>
            </tr>
            <tr>
                <td>${person.partner_id == 0 ? 'å–®èº«ç‹—' : 'éšŠå‹ï¼š' + todayPeople[person.partner_id - 1].name
            }</td >
            </tr >
        </table >
        `)
    }
    function handle_end_game(e) {
        const str = e.target.id;
        const sixthChar = str.charAt(5); // å–å¾—ç¬¬å…­å€‹å­— (å¾ 0 é–‹å§‹ç®—)
        const court_number = parseInt(sixthChar, 10); // å°‡ç¬¬å…­å€‹å­—è½‰æ›æˆæ•¸å­— (10 ä»£è¡¨ä½¿ç”¨åé€²åˆ¶)
        console.log($(`.${court_number}-top-p input`).val())
        console.log($(`.${court_number}-bottom-p input`).val())
        if (empty_court_arr.includes(court_number)) {
            alert(`ç¬¬${court_number}å ´é‚„æ˜¯ç©ºçš„ ç„¡æ³•çµæŸæ¯”è³½`)
        }
        else if ($(`.${court_number}-top-p input`).val() == "" || $(`.${court_number}-bottom-p input`).val() == "") {
            alert("è«‹å¡«å…¥æ¯”åˆ† åœ¨çµæŸæ¯”è³½")
        } else {
            off_court(court_number, $(`.${court_number}-top-p input`).val(), $(`.${court_number}-bottom-p input`).val())
        }

    }
    function off_court(court_number, team_top_score, team_bottom_score) {
        const result = todayPeople.filter(obj => obj.court === court_number);
        result.forEach(obj => obj.court = 0)
        empty_data_to_court(court_number)
        empty_court_arr.push(Number(court_number))
        const win_point = Number(team_top_score) - Number(team_bottom_score)
        console.log(win_point)
        let temp_game_record = ['0', '1', '2', '3', '4', '5', '6']
        result.forEach(obj => {
            if (obj.player == 1 || obj.player == 4) {
                obj.score += (score_count == 0 ? win_point > 0 ? 100 : -100 : score_count == 1 ? 10 * win_point : 20 * win_point)
            } else {
                obj.score -= (score_count == 0 ? win_point > 0 ? 100 : -100 : score_count == 1 ? 10 * win_point : 20 * win_point)
            }
            temp_game_record[Number(obj.player) - 1] = obj.name
        })
        temp_game_record[4] = team_top_score
        temp_game_record[5] = team_bottom_score
        temp_game_record[6] = new Date();
        game_record.push(temp_game_record)
        idle_people_update_to_div()
    }
    function handle_check_info() {
        console.log(todayPeople)
        console.log(empty_court_arr)
        console.log(prepare_PK)
        console.log(game_record)
        const todayPeople_json = JSON.stringify(todayPeople);
        const empty_court_arr_json = JSON.stringify(empty_court_arr);
        const prepare_PK_json = JSON.stringify(prepare_PK);
        const game_record_json = JSON.stringify(game_record);
        $("#all_data_area").append(`<textarea id="todayPeople_data" class="json" >${todayPeople_json}</textarea>`)
        $("#all_data_area").append(`<textarea id="empty_court_arr_data" class="json" >${empty_court_arr_json}</textarea>`)
        $("#all_data_area").append(`<textarea id="prepare_PK_data" class="json" >${prepare_PK_json}</textarea>`)
        $("#all_data_area").append(`<textarea id="game_record_data" class="json" >${game_record_json}</textarea>`)
        $("#all_data_area").append(`éå¿…è¦ä¸è¦ä½¿ç”¨é€™å€‹åŠŸèƒ½ æ ¼å¼éŒ¯å°±æœƒGGå–”`)
        $("#all_data_area").append(`<button id="edit_save">å„²å­˜ä¿®æ”¹çš„è³‡æ–™ </button>`)
        $("#all_data_area").append(`<button id="edit_off">é€€å‡ºç·¨è¼¯æ¨¡å¼ </button>`)
        $("#edit_save").on("click", handle_edit_save)
        $("#edit_off").on("click", handle_edit_off)
    }
    function save_data() {
        // å°‡ç‰©ä»¶é™£åˆ—è½‰æ›ç‚º JSON å­—ä¸²
        const todayPeople_json = JSON.stringify(todayPeople);
        const empty_court_arr_json = JSON.stringify(empty_court_arr);
        const prepare_PK_json = JSON.stringify(prepare_PK);
        const game_record_json = JSON.stringify(game_record);
        // å°‡ JSON å­—ä¸²å­˜å…¥æœ¬åœ°å­˜å„²ä¸­
        localStorage.setItem('todayPeople', todayPeople_json);
        localStorage.setItem('empty_court_arr', empty_court_arr_json);
        localStorage.setItem('prepare_PK', prepare_PK_json);
        localStorage.setItem('game_record', game_record_json);
    }
    function load_data() {
        if (localStorage.getItem('todayPeople') == undefined || localStorage.getItem('empty_court_arr') == undefined || localStorage.getItem('prepare_PK') == undefined) {
            return false
        }
        // å¾æœ¬åœ°å­˜å„²ä¸­å–å‡º JSON å­—ä¸² ä¸¦ä¸”è½‰æ› æ”¾å…¥ æ­£åœ¨ç”¨çš„è³‡æ–™
        todayPeople = JSON.parse(localStorage.getItem('todayPeople'));
        empty_court_arr = JSON.parse(localStorage.getItem('empty_court_arr'));
        prepare_PK = JSON.parse(localStorage.getItem('prepare_PK'));
        game_record = JSON.parse(localStorage.getItem('game_record'));
        put_todayPeople_to_court()
        return true
    }
    function put_todayPeople_to_court() {
        for (let court = 1; court < 5; court++) {
            const temp_arr = todayPeople.filter(obj => obj.court == court)
            if (temp_arr.length != 0) {
                temp_arr.sort((a, b) => a.player - b.player);
                show_player_data_to_court([temp_arr[0], temp_arr[3]], [temp_arr[1], temp_arr[2]], court)
            }
        }
    }
    function set_min_idle(e) {
        console.log('å°‡ min_idle è¨­ç½®ç‚ºï¼š' + $(this).val())
        min_idle = $(this).val()
    }
    function set_prepare_PK() {
        console.log($("#prepare_PK_person").val())
        console.log($("#prepare_PK_set_player").val())
        if (prepare_PK.length < 4) {
            return (alert("è«‹å…ˆæŒ‰ä¸Šå ´äººå“¡ å†åšèª¿æ•´"))
        }
        prepare_PK[Number($("#prepare_PK_set_player").val()) - 1] = todayPeople[Number($("#prepare_PK_person").val()) - 1]
        show_player_data_to_court([prepare_PK[0], prepare_PK[3]], [prepare_PK[1], prepare_PK[2]], 5)

    }
    function set_idle() {
        console.log($("#delete").val())
        console.log($("#idle_round_set").val())
        console.log(todayPeople)
        todayPeople[Number($("#delete").val()) - 1].idleRounds = Number($("#idle_round_set").val())
    }
    function processInput() {
        // ç²å–è¼¸å…¥æ¡†ä¸­çš„å…§å®¹
        const input = document.getElementById('input').value;
        // è™•ç†è¼¸å…¥
        console.log(input);
        // å°‡è³‡æ–™è½‰æ›ç‚ºé™£åˆ—
        const arr = input.split('\n');
        const newArr = arr.filter(item => Object.keys(item).length !== 0);
        // å°‡é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ è½‰æ›ç‚ºç‰©ä»¶
        const objArr = newArr.map((item, index) => ({ id: index + 1, name: item }));
        // è¼¸å‡ºè½‰æ›å¾Œçš„ç‰©ä»¶é™£åˆ—
        console.log(objArr);
        todayPeople = []
        prepare_PK = [];
        empty_court_arr = [1, 2, 3, 4];
        for (let i = 1; i <= objArr.length; i++) {
            todayPeople.push({ id: i, name: objArr[i - 1].name, score: 500 - i, court: 0, idleRounds: 0, player: 0 });
        }
        for (let i = 1; i < 6; i++) {
            empty_data_to_court(i)
        }
        idle_people_update_to_div()
    }
    function prepare_to_delete() {
        $("#delete").empty()
        $("#prepare_PK_person").empty()
        for (i = 0; i < todayPeople.length; i++) {
            $("#delete").append(`<option value='${todayPeople[i].id}'>${todayPeople[i].name}</option>`)
        }
        for (i = 0; i < todayPeople.length; i++) {
            $("#prepare_PK_person").append(`<option value='${todayPeople[i].id}'>${todayPeople[i].name}</option>`)
        }
        for (i = 0; i < todayPeople.length; i++) {
            $("#personal_record").append(`<option value='${todayPeople[i].id}'>${todayPeople[i].name}</option>`)
        }

    }
    function handle_hide_score_change() {
        console.log('å°‡ hide_score è¨­ç½®ç‚ºï¼š' + $(this).val())
        hide_score = $(this).val()
        put_todayPeople_to_court()
        idle_people_update_to_div()
    }
    function handle_score_count_change() {
        console.log('å°‡ score_count è¨­ç½®ç‚ºï¼š' + $(this).val())
        score_count = $(this).val()
    }
    function handle_show_game_record() {
        $("#game_record").empty()
        for (x in game_record) {
            let y = game_record.length - x - 1
            let even_or_odd = y % 2 == 0 ? 'even' : "odd"
            $("#game_record").append(`
            <tr class='${even_or_odd}'><td>${game_record[y][0]}ã€${game_record[y][3]}</td><td>${game_record[y][1]}ã€${game_record[y][2]}</td></tr>
            <tr class='${even_or_odd}'><td>${game_record[y][4]}</td><td>${game_record[y][5]}</td></tr>
            `)
        }
    }
    function handle_set_personal_record() {
        console.log($("#personal_record").val())
        const the_name = todayPeople[Number($("#personal_record").val()) - 1].name
        $("#game_record").empty()
        for (x in game_record) {
            let y = game_record.length - x - 1
            if (game_record[y].includes(the_name))
                $("#game_record").append(`
                    <tr>
                        <td>${game_record[y][0]}ã€${game_record[y][3]}</td>
                        <td>${game_record[y][1]}ã€${game_record[y][2]}</td>
                    </tr>
                    <tr><td>${game_record[y][4]}</td><td>${game_record[y][5]}</td></tr>
                `)
        }
    }
    function handle_edit_save() {
        const todayPeople_json = $("#todayPeople_data").val()
        const empty_court_arr_json = $("#empty_court_arr_data").val()
        const prepare_PK_json = $("#prepare_PK_data").val()
        const game_record_json = $("#game_record_data").val()
        // å°‡ JSON å­—ä¸²å­˜å…¥æœ¬åœ°å­˜å„²ä¸­
        localStorage.setItem('todayPeople', todayPeople_json);
        localStorage.setItem('empty_court_arr', empty_court_arr_json);
        localStorage.setItem('prepare_PK', prepare_PK_json);
        localStorage.setItem('game_record', game_record_json);
        load_data()
    }
    function handle_edit_off() {
        $("#all_data_area").empty()
    }
    function refresh_bulletin_board_message() {
        $("#bulletin_board_message").empty()
        bulletin_board_message.forEach(obj => $("#bulletin_board_message").prepend(obj))
    }
    idle_people_update_to_div()
    $("#pickPeople").on("click", pickPeople)
    $("#go_to_pk").on("click", go_to_PK)
    $(".gameEnd").on("click", handle_end_game)
    $("#check-info").on("click", handle_check_info)
    $("#refresh-idle").on("click", idle_people_update_to_div)
    $("#save-data").on("click", save_data)
    $("#prepare_to_delete").on("click", prepare_to_delete)
    $("#min_idle").on("change", set_min_idle)
    $('#set_idle').on("click", set_idle)
    $('#set_prepare_PK').on("click", set_prepare_PK)
    $("#hide_score").on("change", handle_hide_score_change)
    $("#score_count").on("change", handle_score_count_change)
    $("#show_game_record").on('click', handle_show_game_record)
    $("#set_personal_record").on('click', handle_set_personal_record)

    var client = mqtt.connect("wss://test.mosquitto.org:8081/") // you add a ws:// url here
    client.on('connect', () => {
        console.log('connected.');
        // client.subscribe('Try/MQTT/test')
        client.subscribe('Chill/server/data_refresh')
        // client.subscribe('Chill/#')
        client.on("message", function (topic, payload) {
            var my_string = new TextDecoder().decode(payload);
            if (topic == 'Chill/server/data_refresh') {
                const data_obj = JSON.parse(my_string);
                todayPeople = data_obj.todayPeople;
                game_record = data_obj.game_record;
                prepare_PK = data_obj.prepare_PK;
                bulletin_board_message = data_obj.bulletin_board_message;
                put_todayPeople_to_court()
                idle_people_update_to_div()
                handle_show_game_record()
                refresh_bulletin_board_message()
                if (prepare_PK.length == 4) {
                    show_player_data_to_court([prepare_PK[0], prepare_PK[3]], [prepare_PK[1], prepare_PK[2]], 5)
                }

            }
            // client.end()
        });
        client.publish('Chill/client/ask_for_data_refresh', 'new connect need data refresh')

        // client.publish("mee", "hello",'Try/MQTT/test');    
    });

</script>
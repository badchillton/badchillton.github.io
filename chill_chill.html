<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ç¾½chillç¤¾ </title>
    <!-- å¼•å…¥ Bootstrap çš„ CSS æª”æ¡ˆ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.5.1/math.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .team-color-board {
            border: 3px solid rgb(115, 104, 104);
            box-shadow: 0 0 0 3px black;
        }

        .team-color-0 {
            background-color: #ffd7e9;
        }

        .team-color-1 {
            background-color: #d7f2ff;
        }

        .team-color-2 {
            background-color: #fff7c7;
        }

        .team-color-3 {
            background-color: #c7ffd7;
        }

        .team-color-4 {
            background-color: #e7d7ff;
        }

        .team-color-5 {
            background-color: #ffe7d7;
        }

        .team-color-6 {
            background-color: #f0e3e3;
        }

        .team-color-7 {
            background-color: #d7ffeb;
        }

        .team-color-8 {
            background-color: #ffd7dc;
        }

        .team-color-9 {
            background-color: #d7f7ff;
        }

        .team-color-10 {
            background-color: #fff2d7;
        }

        .team-color-11 {
            background-color: #eaa69d;
        }

        .selected {
            background-color: #007bff;
            color: #fff;
            border: 2px solid #010b17;
        }

        .choosed {
            background-color: yellowgreen;
        }

        .even {
            background-color: rgb(122, 176, 223);
        }

        .odd {
            background-color: antiquewhite;
        }

        #message-box {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background-color: yellow;
            border: 1px solid black;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            z-index: 9999;
            display: none;
        }

        .court {
            background-color: rgb(236, 236, 244);
            border: 2px solid white;
        }

        .row>div {
            padding: 5px;
        }

        .court td {
            /* margin-top: 10px; */
            height: 120px;
        }

        .court .net {
            background-color: aliceblue;
            height: 5px;
        }

        .main-container {
            background-color: gray;
        }

        .gameStart {
            background-color: greenyellow;
            width: 45%;
        }

        .gameEnd {
            background-color: red;
            width: 45%;
            color: aliceblue;
        }

        .person-span {
            margin: 3px;
            border: 1px solid black;
            /* background-color: white; */
        }

        .court-5 {
            /* background-color: white; */
            background-color: burlywood;

        }

        .court-1 {
            /* background-color: lightcoral; */
            background-color: MediumSeaGreen;

        }

        .court-2 {
            background-color: lightgreen;
        }

        .court-3 {
            background-color: MediumSeaGreen;
            /* background-color: lightblue; */
        }

        .court-4 {
            /* background-color: lightyellow; */
            background-color: lightgreen;

        }

        .analysis td {
            height: auto;
        }

        .personal_table {
            background-color: aliceblue;
            margin: 2px;
            border-radius: 3px;
        }

        .json {
            width: 100%;
        }

        .simplify_able_true {
            visibility: hidden;
        }

        .choosed {
            background-color: rgb(216, 235, 133);
        }
    </style>
</head>

<body>
    <div id="message-box">é€™æ˜¯ä¸€å€‹æç¤ºï¼</div>
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- æ¨¡æ…‹æ¡†çš„å…§å®¹ -->
                <div class="record_score_area">
                    <select name="ss" id="which_game">
                        <option value="1">1,2 VS 3,4</option>
                        <option value="1">1,2 VS 3,4</option>
                        <option value="1">1,2 VS 3,4</option>

                    </select>
                    <table class="table">
                        <tr>
                            <td id="player-1-td">1è™Ÿ</td>
                            <td id="player-4-td">4è™Ÿ</td>
                            <td><input id="top_team_score" type="number"></td>
                        </tr>
                        <tr>
                            <td id="player-2-td">2è™Ÿ</td>
                            <td id="player-3-td">3è™Ÿ</td>
                            <td><input id="bottom_team_score" type="number"></td>
                        </tr>
                        <tr>
                            <td><button id="delete_record_score" class="btn btn-primary">åˆªé™¤ç‰¹å®šå ´æ¬¡ç´€éŒ„</button></td>
                            <td></td>
                            <td><button id="record_score" class="btn btn-primary">ç™»è¨˜åˆ†æ•¸</button></td>
                        </tr>

                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid main-container">
        <div class="row court-container">
        </div>

        <div class="row">
            <div class="col-4">
                <h1>å³å°‡ä¸Šå ´äººå“¡</h1>
                <div class="simplify_able">
                    <button class="btn-primary btn" id="pickPeople"> é¸äººä¸Šå ´</button>
                    <button class="go_to_pk btn-primary btn" id="go_to_pk">å»ï¼Ÿçƒå ´æ¯”è³½</button>
                    <button id="open_modal_of_record_score" class="btn btn-primary ml-2">ç™»å…¥åˆ†æ•¸</button>
                    <span class="wait_to_register_text" id="wait_to_register_text">ç­‰å¾…ç™»è¨˜å ´æ¬¡ï¼š</span>


                </div>
                <div class="col">
                    <table class="table table-bordered court-5 court">
                        <tr>
                            <td class="player1"></td>
                            <td class="player4"></td>
                        </tr>
                        <tr>
                            <td class='net'> </td>
                            <td class='net'> </td>
                        </tr>
                        <tr>
                            <td class="player2"></td>
                            <td class="player3"></td>
                        </tr>
                    </table>
                    <div class="simplify_able">
                        <button class="button" id="check-info">æª¢è¦–è³‡æ–™</button>
                        <button class="button" id="refresh-idle">åˆ·æ–°é–’ç½®äººå“¡è³‡æ–™</button>
                        <button class="button" id="save-data">å­˜è³‡æ–™</button>
                        <button class="button" id="prepare_to_delete">æº–å‚™è¨­å®šäººå“¡ </button>
                        <button class="button" id="send_data">ç™¼é€è³‡æ–™ </button>
                        <button class="button" id="delete_today_data">åˆªé™¤æœ¬åœ°ç«¯ç•¶æ—¥è³‡æ–™ </button>
                    </div>
                    <fieldset class="simplify_able">
                        <legend>æŒ‡å®šä¸Šå ´è¨­å®šå€</legend>
                        <select name="prepare_PK_set_player" id="prepare_PK_set_player">
                            <option value="1">player1(å·¦ä¸Š)</option>
                            <option value="2">player2(å·¦ä¸‹)</option>
                            <option value="3">player3(å³ä¸‹)</option>
                            <option value="4">player4(å³ä¸Š)</option>
                        </select>
                        <select name="prepare_PK_person" id="prepare_PK_person">
                        </select>
                        <button id="set_prepare_PK">ç¢ºèªåŸ·è¡Œ</button>
                    </fieldset>
                    <fieldset class="simplify_able">
                        <legend>ç¶å®šçµ„åˆå€</legend>
                        <select name="binding_partners_1" id="binding_partners_1">
                        </select>
                        <select name="binding_partners_2" id="binding_partners_2">
                        </select>
                        <button id="set_binding">ç¢ºèªåŸ·è¡Œç¶å®šæ“ä½œ</button>
                        <button id="set_unbinding">ç¢ºèªåŸ·è¡Œè§£é™¤ç¶å®šæ“ä½œ</button>
                    </fieldset>
                    <fieldset class="simplify_able">
                        <legend>idleRoundsè¨­å®šå€</legend>
                        <select name="idle_round_set" id="idle_round_set">
                            <option value="50">è¶…ç´šå›æ­¸</option>
                            <option value="0">å›æ­¸</option>
                            <option value="-999">æš«é›¢</option>
                        </select>
                        <select name="idle_round_person" id="delete">
                        </select>
                        <button id="set_idle">ç¢ºèªåŸ·è¡Œ</button>
                    </fieldset>
                    <fieldset>
                        <legend>ç’°å¢ƒè®Šæ•¸è¨­å®šå€</legend>
                        <select name="min_idle" id="min_idle">
                            <option value="0">æœ€å°ç­‰å¾…å ´æ•¸:0</option>
                            <option value="1">æœ€å°ç­‰å¾…å ´æ•¸:1</option>
                            <option value="2">æœ€å°ç­‰å¾…å ´æ•¸:2</option>
                            <option value="3">æœ€å°ç­‰å¾…å ´æ•¸:3</option>
                            <option value="4">æœ€å°ç­‰å¾…å ´æ•¸:4</option>
                        </select>
                        <select id="hide_score">
                            <option value="1">éš±è—åˆ†æ•¸</option>
                            <option value="0">é¡¯ç¤ºåˆ†æ•¸</option>
                        </select>
                        <select id="score_count">
                            <option value="1">åˆ†å·®*10åˆ†</option>
                            <option value="2">åˆ†å·®*20åˆ†</option>
                        </select>
                        <!-- <select id="simplify_do">
                            <option value="0">ä¸ç°¡åŒ–æ“ä½œæµç¨‹</option>
                            <option value="1">ç°¡åŒ–æ“ä½œæµç¨‹</option>
                        </select>
                        <select id="off_court_check">
                            <option value="0">ä¸‹å ´ä¸éœ€è¦ç¢ºèª</option>
                            <option value="1">ä¸‹å ´éœ€è¦ç¢ºèª</option>
                        </select> -->
                    </fieldset>
                    <fieldset class="simplify_able">
                        <legend>å€‹äººæˆ°ç¸¾æŸ¥è©¢</legend>
                        <select name="personal_record" id="personal_record">
                        </select>
                        <button id="set_personal_record">ç¢ºèªåŸ·è¡Œ</button>
                        <button class="button" id="show_game_record">é¡¯ç¤ºæ‰€æœ‰æ¯”è³½ç´€éŒ„ </button>
                    </fieldset>
                </div>
            </div>
            <div class="col-8">
                <h1> å‚™æˆ°å€</h1>
                <div class="row person-wait card-container"></div>
                <h2> æ“ä½œæŒ‰éˆ•å€</h2>
                <div class="row button-group">
                    <button id="binding" class="btn btn-primary ml-5">ç¶å®š</button>
                    <button id="go_to_sleep" class="btn btn-primary ml-5">å»ä¼‘æ¯å€</button>
                    <button id="go_to_wait" class="btn btn-primary ml-5">å»å‚™æˆ°å€</button>
                    <button id="cancel_binding" class="btn btn-primary ml-5">è§£é™¤ç¶å®š</button>
                    <button id="cancel_choosed" class="btn btn-primary ml-5">æ¸…é™¤é¸å–</button>
                </div>
                <h1> ä¼‘æ¯å€</h1>
                <div class="row person-sleep"></div>
                <!-- å¤šè¡Œæ–‡æœ¬è¼¸å…¥æ¡† -->
                <textarea id="input" rows="5"></textarea>
                <!-- æŒ‰éˆ• -->
                <button onclick="processInput()">è™•ç†è¼¸å…¥</button>
                <div id="all_data_area"></div>
                <div id="bulletin_board">
                    <h1>ğŸ“°å…¬å¸ƒæ¬„ğŸ“°</h1>
                    <div id="bulletin_board_message"></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <table id="game_record" class="table-bordered"></table>
            </div>
        </div>

    </div>

    <!-- å¼•å…¥ jQuery å’Œ Bootstrap çš„ JS æª”æ¡ˆ -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>

<script>
    //é€™å››å€‹è®Šæ•¸æœƒå¯«å…¥local storage
    let todayPeople = [];
    let prepare_PK = [];
    let empty_court_arr = [1, 2, 3, 4];
    let game_record = [];
    let bulletin_board_message = []
    let binding_team_list = []
    let wait_to_register_list = []
    //é€™4å€‹è®Šæ•¸ æ¯æ¬¡é€²ä¾†æœƒé‡ç½®æˆé€™æ¨£
    let simplify = '0';
    let min_idle = 0;
    let hide_score = '1';
    let score_count = '1';
    let off_court_check = '0';
    //ç”¢ç”Ÿ4å€‹ä¸»è¦æ¯”è³½å ´åœ°
    for (let i = 1; i < 5; i++) {
        $(".court-container").append(court_generate(i))
    }
    //å¾local storage è¼‰å…¥è³‡æ–™ è‹¥æ²’æœ‰è³‡æ–™å‰‡ç”¢ç”Ÿå‡è³‡æ–™
    if (!load_data()) {
        for (let i = 1; i <= 28; i++) {
            todayPeople.push({ id: i, name: `Object ${i}`, score: 500 - i, court: 0, idleRounds: 0, player: 0, partner_id: 0, choosed: 0 });
        }
    }
    function show_message(message) {
        // ç²å–message-boxå…ƒç´ 
        const messageBox = document.getElementById("message-box");
        // è¨­ç½®è¨Šæ¯å…§å®¹
        messageBox.innerHTML = message;
        // é¡¯ç¤ºmessage-boxå…ƒç´ 
        messageBox.style.display = "block";
        // è¨­ç½®å®šæ™‚å™¨
        setTimeout(function () {
            // éš±è—message-boxå…ƒç´ 
            messageBox.style.display = "none";
        }, 2000);

    }
    function personal_card(person) {
        return (`${person.name}<br>âš”ï¸ï¼š${hide_score == 1 ? '???' : person.score}`)
    }
    function show_player_data_to_court(topTeamPlayers, bottomTeamPlayers, court) {
        //topTeamPlayers, bottomTeamPlayers éƒ½æ˜¯array æ”¾äº†å…©å€‹é¸æ‰‹çš„è³‡æ–™
        //court æ˜¯ int è¡¨ç¤ºç¬¬å¹¾å ´æ¬¡
        console.log(topTeamPlayers)
        console.log("flag")
        $(`.court-${court} .player1`).html(personal_card(topTeamPlayers[0]))
        $(`.court-${court} .player2`).html(personal_card(bottomTeamPlayers[0]))
        $(`.court-${court} .player3`).html(personal_card(bottomTeamPlayers[1]))
        $(`.court-${court} .player4`).html(personal_card(topTeamPlayers[1]))
        $(`.analysis-${court} .top`).html(`${topTeamPlayers[0].score + topTeamPlayers[1].score}`)
        $(`.analysis-${court} .bottom`).html(`${bottomTeamPlayers[0].score + bottomTeamPlayers[1].score}`)
    }
    function empty_data_to_court(court) {
        $(`.court-${court} .player1`).empty()
        $(`.court-${court} .player2`).empty()
        $(`.court-${court} .player3`).empty()
        $(`.court-${court} .player4`).empty()
        $(`.analysis-${court} .top`).empty()
        $(`.analysis-${court} .bottom`).empty()
    }
    function court_generate(court_number) {
        return (`<div class="col-sm">
                <table class="table table-bordered court-${court_number} court">
                    <tr>
                        <td class="player1"></td>
                        <td class="player4"></td>
                    </tr>
                    <tr>
                        <td class='net'> </td>
                        <td class='net'> </td>
                    </tr>
                    <tr>
                        <td class="player2"></td>
                        <td class="player3"></td>
                    </tr>
                </table>
                <button class="gameStart simplify_able" id="court${court_number}start">æ¯”è³½é–‹å§‹</button>
                <button class="gameEnd" id="court${court_number}end">æ¯”è³½çµæŸ</button>
                <table class="analysis-${court_number} analysis" style="width:100%; table-layout:fixed;">
                    <tr>
                        <th>æˆ°é¬¥åˆ†æ</th>
                        <th>æˆ°åŠ›æŒ‡æ•¸</th>
                        <th>å¯¦éš›æ¯”åˆ†</th>
                    </tr>
                    <tr>
                        <td>ä¸Šæ–¹</td>
                        <td class="top"></td>
                        <td class="${court_number}-top-p"> <input style="width:80%"/></td>
                    </tr>
                    <tr>
                        <td>ä¸‹æ–¹</td>
                        <td class="bottom"></td>
                        <td class="${court_number}-bottom-p"> <input style="width:80%"/></td>
                    </tr>
                </table>
            </div>`)
    }
    function auto_choose_players(allPlayers) {
        //å°‡å…¨éƒ¨äººå“¡çš„è³‡æ–™è¼¸å…¥ 
        //å…ˆæ‰¾å‡ºä¸åœ¨å ´æ¯”è³½çš„äºº
        const result = allPlayers.filter(obj => obj.court === 0);
        if (result.length < 4) {
            return (alert('äººæ•¸ä¸è¶³4äºº ç„¡æ³•åŒ¹é…äººé¸'))
        }
        // æ‰¾å‡º idleRounds æœ€é«˜çš„äºº
        const oldestPerson = result.reduce((prev, current) => {
            return (prev.idleRounds > current.idleRounds) ? prev : current;
        });
        let top_team = []
        //ç‚ºç­‰æœ€ä¹…çš„äºº é…å° ä»–çš„éšŠå‹ è‹¥æœ‰å¤«å¦»æª”ç›´æ¥çµ„éšŠ æ²’æœ‰å‰‡æ‰¾æœ€æ¥è¿‘çš„
        if (oldestPerson.partner_id == 0) {
            // æ‰¾å‡ºå’Œé€™å€‹äºº score æœ€æ¥è¿‘çš„å…¶ä»–1äºº è¦æ˜¯å–®èº«  
            let otherPeople = result.filter(person => person.name !== oldestPerson.name && person.idleRounds >= min_idle && person.partner_id == 0);
            if (otherPeople.length < 3) {
                otherPeople = result.filter(person => person.name !== oldestPerson.name && person.idleRounds >= 0 && person.partner_id == 0);
            }
            otherPeople.sort((a, b) => {
                const diffA = Math.abs(a.score - oldestPerson.score);
                const diffB = Math.abs(b.score - oldestPerson.score);
                return diffA - diffB;
            });
            const closestPerson = otherPeople.slice(0, 1);
            top_team = [oldestPerson, closestPerson[0]]
        } else {
            top_team = [oldestPerson, todayPeople[oldestPerson.partner_id - 1]]
        }
        // æ‰¾å‡ºå’Œé€™çµ„ å¯¦åŠ›æ¥è¿‘çš„éšŠä¼
        console.log(top_team)
        let otherPeople = result.filter(person => person.name !== top_team[0].name && person.name !== top_team[1].name && person.idleRounds >= min_idle);
        if (otherPeople.length < 3) {
            otherPeople = result.filter(person => person.name !== top_team[0].name && person.name !== top_team[1].name && person.idleRounds >= 0);
        }
        let partner_team = []
        otherPeople.forEach(obj => {
            if (obj.partner_id != 0) {
                partner_team.push([obj, todayPeople[obj.partner_id - 1]])
            }
        });
        let other_single_people = otherPeople.filter(obj => obj.partner_id == 0)
        other_single_people.sort((a, b) => b.score - a.score)
        for (let x = 0; x < other_single_people.length - 1; x++) {
            partner_team.push([other_single_people[x], other_single_people[x + 1]])
        }
        partner_team.sort((a, b) => {
            const diffA = Math.abs(a[0].score + a[1].score - top_team[0].score - top_team[1].score);
            const diffB = Math.abs(b[0].score + b[1].score - top_team[0].score - top_team[1].score);
            return diffA - diffB;
        })
        // é‡çµ„é™£åˆ—
        // const combinedArray = [oldestPerson, ...closestPeople];
        // // æŒ‰ç…§åˆ†æ•¸é«˜ä½æ’åº
        // combinedArray.sort((a, b) => b.score - a.score);
        combinedArray = [top_team[0], partner_team[0][0], partner_team[0][1], top_team[1]]
        console.log(combinedArray)
        return combinedArray
    }
    function pickPeople() {
        // const pickedPeople = auto_choose_players(todayPeople)
        const four_people=letsPlay(todayPeople)
        const pickedPeople = [todayPeople[four_people[0]-1],todayPeople[four_people[1]-1],todayPeople[four_people[2]-1],todayPeople[four_people[3]-1]]

        prepare_PK_refresh(pickedPeople)
        show_player_data_to_court([pickedPeople[0], pickedPeople[3]], [pickedPeople[1], pickedPeople[2]], 5)

    }
    function prepare_PK_refresh(pickedPeople) {
        prepare_PK = pickedPeople
    }
    function go_to_PK() {
        //æŠŠè³‡æ–™æ”¹ä¸Šå» ä¸¦é¡¯ç¤ºäººå“¡åœ¨å°çš„ä½ç½®
        if (empty_court_arr.length == 0) {
            alert("ç¾åœ¨æ²’æœ‰ç©ºå ´ ç„¡æ³•é€²è¡Œæ¯”è³½")
        } else {
            const court = empty_court_arr.length > 0 ? empty_court_arr[0] : 0
            if (prepare_PK.length != 4) {
                return (alert("è«‹å…ˆé¸äºº å†å»PK"))
            }
            prepare_PK.forEach((person, index) => {
                person.court = court;
                person.player = index + 1
            });
            show_player_data_to_court([prepare_PK[0], prepare_PK[3]], [prepare_PK[1], prepare_PK[2]], court)
            const now = new Date();
            const timezoneOffsetInMs = now.getTimezoneOffset() * 60 * 1000;
            const currentTimeInMs = now.getTime() - timezoneOffsetInMs;
            const currentTime = new Date(currentTimeInMs);
            const hours = currentTime.getHours().toString().padStart(2, '0');
            const minutes = currentTime.getMinutes().toString().padStart(2, '0');
            const seconds = currentTime.getSeconds().toString().padStart(2, '0');
            const currentTime_hms = `${hours}:${minutes}:${seconds}`
            const PK_court = empty_court_arr.shift()
            bulletin_board_message.push(`ã€Š${prepare_PK[0].name}ã€‹ å’Œ ã€Š${prepare_PK[3].name}ã€‹ VS ã€Š${prepare_PK[1].name}ã€‹ å’Œ ã€Š${prepare_PK[2].name}ã€‹ï¼Œè«‹è‡³ç¬¬${PK_court}çƒå ´æ¯”è³½ã€‚ [ ${currentTime_hms} ]<br>`)
            client.publish('Chill/PY', `[${prepare_PK[0].name}] å’Œ [${prepare_PK[3].name}] VS [${prepare_PK[1].name}] å’Œ [${prepare_PK[2].name}]ï¼Œè«‹è‡³ç¬¬${PK_court}çƒå ´æ¯”è³½ã€‚`)
            refresh_bulletin_board_message()
            const speak_text = String(`å¤§æœƒå ±å‘Šï¼šã€Š${prepare_PK[0].name}ã€‹ å’Œ ã€Š${prepare_PK[3].name}ã€‹ å°æˆ° ã€Š${prepare_PK[1].name}ã€‹ å’Œ ã€Š${prepare_PK[2].name}ã€‹ï¼Œè«‹è‡³ç¬¬${PK_court}çƒå ´æ¯”è³½ã€‚`)
            speak(speak_text);
            prepare_PK = [];
            empty_data_to_court(5)
            todayPeople.forEach(person => {
                if (person.court == 0) {
                    person.idleRounds += 1;
                } else {
                    person.idleRounds = 0;
                }
            })
            idle_people_update_to_div()
        }

    }
    function refresh_bulletin_board_message() {
        $("#bulletin_board_message").empty()
        bulletin_board_message.forEach(obj => $("#bulletin_board_message").prepend(obj))
    }
    function idle_people_update_to_div() {
        const idle_people = todayPeople.filter(obj => obj.court === 0).sort((a, b) => b.idleRounds - a.idleRounds)
        $(".person-wait").empty()
        $(".person-sleep").empty()
        for (x in idle_people) {
            if (idle_people[x].idleRounds < 0) {
                $(".person-sleep").append(idle_personal_card(idle_people[x]))
            } else {
                $(".person-wait").append(idle_personal_card(idle_people[x]))
            }
            idle_people[x].choosed = 0;
        }
        console.log(binding_team_list)
        binding_team_list.forEach((obj, index) => {
            obj.forEach((in_obj, in_index) => {
                $(`#${in_obj}`).addClass(`team-color-${index}`)
            })
        })
        $(".selectable").click(handle_personal_card_click)
    }
    function idle_personal_card(person) {
        // return (`
        // <table class='personal_table table-bordered personal-card-${person.id} personal-card ${person.choosed == '1' ? 'choosed' : 'no-choosed'}' id='${person.id}'> 
        //     <tr>
        //         <td>${person.name}</td>
        //     </tr>
        //     <tr>
        //         <td>${hide_score == 1 ? '???' : person.score}</td>
        //     </tr>
        //     <tr>
        //         <td>${person.idleRounds}</td>
        //     </tr>
        //     <tr>
        //         <td>${person.partner_id == 0 ? 'å–®èº«ç‹—' : 'éšŠå‹ï¼š' + todayPeople[person.partner_id - 1].name}
        //             </td >
        //     </tr >
        // </table >
        // `)
        return (`
        <div class='col-md-2'>
        <div class="card selectable team-color-board" id='${person.id}'>
                        <div class="card-body">
                            <h5 class="card-title">${person.name}</h5>
                            <p class="card-text">${hide_score == 1 ? '???' : person.score}ï¼${person.idleRounds}</p>
                            <h6 class="team-color">éšŠä¼è‰²</h6>
                        </div>
                    </div>
                    </div>`)
    }
    function handle_personal_card_click(e) {
        const click_id = parseInt(e.currentTarget.id)
        console.log(`#${e.currentTarget.id}`)
        if (todayPeople[click_id - 1].choosed == 1) {
            $(`#${e.currentTarget.id}`).removeClass("selected")
            todayPeople[click_id - 1].choosed = 0;
        } else {
            todayPeople[click_id - 1].choosed = 1;
            $(`#${e.currentTarget.id}`).addClass("selected")
        }


    }
    function handle_end_game(e) {
        const str = e.target.id;
        const sixthChar = str.charAt(5); // å–å¾—ç¬¬å…­å€‹å­— (å¾ 0 é–‹å§‹ç®—)
        const court_number = parseInt(sixthChar, 10); // å°‡ç¬¬å…­å€‹å­—è½‰æ›æˆæ•¸å­— (10 ä»£è¡¨ä½¿ç”¨åé€²åˆ¶)
        const top_score = $(`.${court_number}-top-p input`).val()
        const bottom_score = $(`.${court_number}-bottom-p input`).val()
        if (empty_court_arr.includes(court_number)) {
            alert(`ç¬¬${court_number}å ´é‚„æ˜¯ç©ºçš„ ç„¡æ³•çµæŸæ¯”è³½`)
        }
        else if ($(`.${court_number}-top-p input`).val() == "" || $(`.${court_number}-bottom-p input`).val() == "") {
            alert("è«‹å¡«å…¥æ¯”åˆ† åœ¨çµæŸæ¯”è³½")
        } else {
            if (off_court_check == '1') {
                var confirmed = confirm(`ç¬¬${court_number}çƒå ´çš„æ¯”è³½ æ¯”åˆ†æ˜¯ ${top_score}æ¯”${bottom_score} ç¢ºèªåŸ·è¡Œçµæœå—ï¼Ÿ`);
                if (confirmed) {
                    off_court(court_number, $(`.${court_number}-top-p input`).val(), $(`.${court_number}-bottom-p input`).val())
                }
            } else {
                off_court(court_number, $(`.${court_number}-top-p input`).val(), $(`.${court_number}-bottom-p input`).val())
            }
        }
    }
    function handle_end_game_new(e) {
        const str = e.target.id;
        const sixthChar = str.charAt(5); // å–å¾—ç¬¬å…­å€‹å­— (å¾ 0 é–‹å§‹ç®—)
        const court_number = parseInt(sixthChar, 10); // å°‡ç¬¬å…­å€‹å­—è½‰æ›æˆæ•¸å­— (10 ä»£è¡¨ä½¿ç”¨åé€²åˆ¶)
        console.log(court_number)
        if (empty_court_arr.includes(court_number)) {
            return (alert(`ç¬¬${court_number}å ´é‚„æ˜¯ç©ºçš„ ç„¡æ³•çµæŸæ¯”è³½`))
        }
        off_court_new(court_number)
    }
    function off_court_new(court_number) {
        const result = todayPeople.filter(obj => obj.court === court_number);
        const temp_id_list = [1, 2, 3, 4]
        result.forEach(obj => {
            temp_id_list[Number(obj.player) - 1] = obj.id
            obj.court = 0;
        })
        wait_to_register_list.push(temp_id_list)
        empty_data_to_court(court_number)
        empty_court_arr.push(Number(court_number))
        idle_people_update_to_div()
        save_data()
        if (simplify == '1') {
            go_to_PK()
            pickPeople()
        }
        send_data()
        refresh_wait_to_register_text();
    }
    function off_court(court_number, team_top_score, team_bottom_score) {
        const result = todayPeople.filter(obj => obj.court === court_number);
        result.forEach(obj => obj.court = 0)
        empty_data_to_court(court_number)
        empty_court_arr.push(Number(court_number))
        const win_point = Number(team_top_score) - Number(team_bottom_score)
        console.log(win_point)
        let temp_game_record = ['0', '1', '2', '3', '4', '5', '6']
        result.forEach(obj => {
            if (obj.player == 1 || obj.player == 4) {
                obj.score += (score_count == 0 ? win_point > 0 ? 100 : -100 : score_count == 1 ? 10 * win_point : 20 * win_point)
            } else {
                obj.score -= (score_count == 0 ? win_point > 0 ? 100 : -100 : score_count == 1 ? 10 * win_point : 20 * win_point)
            }
            temp_game_record[Number(obj.player) - 1] = obj.name
        })
        temp_game_record[4] = team_top_score
        temp_game_record[5] = team_bottom_score
        temp_game_record[6] = new Date();
        game_record.push(temp_game_record)
        idle_people_update_to_div()
        save_data()
        if (simplify == '1') {
            go_to_PK()
            pickPeople()
        }
        send_data()
    }
    function handle_check_info() {
        console.log(todayPeople)
        console.log(empty_court_arr)
        console.log(prepare_PK)
        console.log(game_record)
        const todayPeople_json = JSON.stringify(todayPeople);
        const empty_court_arr_json = JSON.stringify(empty_court_arr);
        const prepare_PK_json = JSON.stringify(prepare_PK);
        const game_record_json = JSON.stringify(game_record);
        const bulletin_board_message_json = JSON.stringify(bulletin_board_message);
        $("#all_data_area").append(`<textarea id = "todayPeople_data" class="json" > ${todayPeople_json}</textarea > `)
        $("#all_data_area").append(`<textarea id = "empty_court_arr_data" class="json" > ${empty_court_arr_json}</textarea > `)
        $("#all_data_area").append(`<textarea id = "prepare_PK_data" class="json" > ${prepare_PK_json}</textarea > `)
        $("#all_data_area").append(`<textarea id = "game_record_data" class="json" > ${game_record_json}</textarea > `)
        $("#all_data_area").append(`<textarea id = "game_record_data" class="json" > ${bulletin_board_message_json}</textarea > `)
        $("#all_data_area").append(`éå¿…è¦ä¸è¦ä½¿ç”¨é€™å€‹åŠŸèƒ½ æ ¼å¼éŒ¯å°±æœƒGGå–”`)
        $("#all_data_area").append(`<button id = "edit_save" > å„²å­˜ä¿®æ”¹çš„è³‡æ–™ </button > `)
        $("#all_data_area").append(`<button id = "edit_off" > é€€å‡ºç·¨è¼¯æ¨¡å¼ </button > `)
        $("#edit_save").on("click", handle_edit_save)
        $("#edit_off").on("click", handle_edit_off)
    }
    function save_data() {
        // å°‡ç‰©ä»¶é™£åˆ—è½‰æ›ç‚º JSON å­—ä¸²
        const todayPeople_json = JSON.stringify(todayPeople);
        const empty_court_arr_json = JSON.stringify(empty_court_arr);
        const prepare_PK_json = JSON.stringify(prepare_PK);
        const game_record_json = JSON.stringify(game_record);
        const bulletin_board_message_json = JSON.stringify(bulletin_board_message);
        // å°‡ JSON å­—ä¸²å­˜å…¥æœ¬åœ°å­˜å„²ä¸­
        localStorage.setItem('todayPeople', todayPeople_json);
        localStorage.setItem('empty_court_arr', empty_court_arr_json);
        localStorage.setItem('prepare_PK', prepare_PK_json);
        localStorage.setItem('game_record', game_record_json);
        localStorage.setItem('bulletin_board_message', bulletin_board_message_json);
    }
    function load_data() {
        if (localStorage.getItem('todayPeople') == undefined || localStorage.getItem('empty_court_arr') == undefined || localStorage.getItem('prepare_PK') == undefined) {
            return false
        }
        // å¾æœ¬åœ°å­˜å„²ä¸­å–å‡º JSON å­—ä¸² ä¸¦ä¸”è½‰æ› æ”¾å…¥ æ­£åœ¨ç”¨çš„è³‡æ–™
        todayPeople = JSON.parse(localStorage.getItem('todayPeople'));
        empty_court_arr = JSON.parse(localStorage.getItem('empty_court_arr'));
        prepare_PK = JSON.parse(localStorage.getItem('prepare_PK'));
        game_record = JSON.parse(localStorage.getItem('game_record'));
        bulletin_board_message = JSON.parse(localStorage.getItem('bulletin_board_message')) ? JSON.parse(localStorage.getItem('bulletin_board_message')) : [];
        put_todayPeople_to_court()
        return true
    }
    function put_todayPeople_to_court() {
        for (let court = 1; court < 6; court++) {
            const temp_arr = todayPeople.filter(obj => obj.court == court)
            if (temp_arr.length != 0) {
                temp_arr.sort((a, b) => a.player - b.player);
                show_player_data_to_court([temp_arr[0], temp_arr[3]], [temp_arr[1], temp_arr[2]], court)
            }

        }
    }
    function set_min_idle(e) {
        console.log('å°‡ min_idle è¨­ç½®ç‚ºï¼š' + $(this).val())
        min_idle = $(this).val()
    }
    function set_prepare_PK() {
        console.log($("#prepare_PK_person").val())
        console.log($("#prepare_PK_set_player").val())
        if (prepare_PK.length < 4) {
            return (alert("è«‹å…ˆæŒ‰ä¸Šå ´äººå“¡ å†åšèª¿æ•´"))
        }
        prepare_PK[Number($("#prepare_PK_set_player").val()) - 1] = todayPeople[Number($("#prepare_PK_person").val()) - 1]
        show_player_data_to_court([prepare_PK[0], prepare_PK[3]], [prepare_PK[1], prepare_PK[2]], 5)

    }
    function set_idle() {
        console.log($("#delete").val())
        console.log($("#idle_round_set").val())
        console.log(todayPeople)
        todayPeople[Number($("#delete").val()) - 1].idleRounds = Number($("#idle_round_set").val())
    }
    function processInput() {
        // ç²å–è¼¸å…¥æ¡†ä¸­çš„å…§å®¹
        const input = document.getElementById('input').value;
        // è™•ç†è¼¸å…¥
        console.log(input);
        // å°‡è³‡æ–™è½‰æ›ç‚ºé™£åˆ—
        // const regex = /(\d+)\.\[(\d*)\](.*)/g;
        const regex = /(\d+)\.\[(\d*\.?\d*)\](.*)/g;

        const result = [];
        while ((matches = regex.exec(input)) !== null) {
            const id = parseInt(matches[1]);
            const score = matches[2] !== '' ? parseInt(parseFloat(matches[2]) * 100) : 0;
            const name = matches[3].trim();
            result.push({ id, score, name });
        }
        console.log(result);
        todayPeople = []
        prepare_PK = [];
        empty_court_arr = [1, 2, 3, 4];
        for (let i = 1; i <= result.length; i++) {
            todayPeople.push({ id: i, name: result[i - 1].name, score: result[i - 1].score, court: 0, idleRounds: 0, player: 0, partner_id: 0, choosed: 0 });
        }
        for (let i = 1; i < 6; i++) {
            empty_data_to_court(i)
        }
        idle_people_update_to_div()
        save_data()
    }
    function prepare_to_delete() {
        $("#delete").empty()
        $("#prepare_PK_person").empty()
        for (i = 0; i < todayPeople.length; i++) {
            $("#delete").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
        }
        for (i = 0; i < todayPeople.length; i++) {
            $("#prepare_PK_person").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
        }
        for (i = 0; i < todayPeople.length; i++) {
            $("#personal_record").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
            $("#binding_partners_2").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
            $("#binding_partners_1").append(`<option value = '${todayPeople[i].id}' > ${todayPeople[i].name}</option > `)
        }

    }
    function handle_hide_score_change() {
        console.log('å°‡ hide_score è¨­ç½®ç‚ºï¼š' + $(this).val())
        hide_score = $(this).val()
        put_todayPeople_to_court()
        idle_people_update_to_div()
    }
    function handle_score_count_change() {
        console.log('å°‡ score_count è¨­ç½®ç‚ºï¼š' + $(this).val())
        score_count = $(this).val()
    }
    function handle_simplify_do_change() {
        console.log('å°‡ simplify è¨­ç½®ç‚ºï¼š' + $(this).val())
        simplify = $(this).val()
        if (simplify == "1") {
            $(".simplify_able").addClass("simplify_able_true")
        } else {
            $(".simplify_able").removeClass("simplify_able_true")
        }
    }
    function handle_off_court_check_change() {
        console.log('å°‡ off_court_check è¨­ç½®ç‚ºï¼š' + $(this).val())
        off_court_check = $(this).val()
    }
    function handle_show_game_record() {
        $("#game_record").empty()
        for (x in game_record) {
            let y = game_record.length - x - 1
            let even_or_odd = y % 2 == 0 ? 'even' : "odd"
            $("#game_record").append(`
            <tr class='${even_or_odd}'><td>${game_record[y][0]}ã€${game_record[y][3]}</td><td>${game_record[y][1]}ã€${game_record[y][2]}</td></tr>
            <tr class='${even_or_odd}'><td>${game_record[y][4]}</td><td>${game_record[y][5]}</td></tr>
            `)
        }
    }
    function handle_set_personal_record() {
        console.log($("#personal_record").val())
        const the_name = todayPeople[Number($("#personal_record").val()) - 1].name
        $("#game_record").empty()
        for (x in game_record) {
            let y = game_record.length - x - 1
            if (game_record[y].includes(the_name))
                $("#game_record").append(`
        <tr >
                        <td>${game_record[y][0]}ã€${game_record[y][3]}</td>
                        <td>${game_record[y][1]}ã€${game_record[y][2]}</td>
                    </tr >
        <tr><td>${game_record[y][4]}</td><td>${game_record[y][5]}</td></tr>
    `)
        }
    }
    function handle_edit_save() {
        const todayPeople_json = $("#todayPeople_data").val()
        const empty_court_arr_json = $("#empty_court_arr_data").val()
        const prepare_PK_json = $("#prepare_PK_data").val()
        const game_record_json = $("#game_record_data").val()
        // å°‡ JSON å­—ä¸²å­˜å…¥æœ¬åœ°å­˜å„²ä¸­
        localStorage.setItem('todayPeople', todayPeople_json);
        localStorage.setItem('empty_court_arr', empty_court_arr_json);
        localStorage.setItem('prepare_PK', prepare_PK_json);
        localStorage.setItem('game_record', game_record_json);
        load_data()
    }
    function handle_edit_off() {
        $("#all_data_area").empty()
    }
    function handle_set_binding() {
        const binding_1 = Number($("#binding_partners_1").val())
        const binding_2 = Number($("#binding_partners_2").val())
        if (binding_1 == binding_2) {
            return (alert("éœ€è¦ä¸åŒçš„å…©å€‹äººæ‰èƒ½ç¶å®š"))
        }
        if (todayPeople[binding_1 - 1].partner_id != 0) {
            return (alert("éœ€è¦å…ˆè§£é™¤ç¬¬ä¸€å€‹é¸æ“‡çš„äººçš„ç¶å®š"))
        }
        if (todayPeople[binding_2 - 1].partner_id != 0) {
            return (alert("éœ€è¦å…ˆè§£é™¤ç¬¬äºŒå€‹é¸æ“‡çš„äººçš„ç¶å®š"))
        }
        todayPeople[binding_1 - 1].partner_id = binding_2;
        todayPeople[binding_2 - 1].partner_id = binding_1;
        show_message(`${todayPeople[binding_1 - 1].name} èˆ‡ ${todayPeople[binding_2 - 1].name} æˆåŠŸç¶å®š`)
        idle_people_update_to_div()
    }
    function handle_set_unbinding() {
        const binding_1 = Number($("#binding_partners_1").val())
        const binding_2 = Number($("#binding_partners_2").val())
        if (binding_1 == binding_2) {
            return (alert("éœ€è¦ä¸åŒçš„å…©å€‹äººæ‰èƒ½ç¶å®š"))
        }
        if (todayPeople[binding_1 - 1].partner_id == 0) {
            return (alert("ç¬¬ä¸€å€‹äººæ²’æœ‰ç¶å®šçš„éšŠå‹"))
        }
        if (todayPeople[binding_2 - 1].partner_id == 0) {
            return (alert("ç¬¬äºŒå€‹äººæ²’æœ‰ç¶å®šçš„éšŠå‹"))
        }
        if (todayPeople[binding_2 - 1].partner_id != binding_1) {
            return (alert("é€™å…©å€‹äººç›®å‰ä¸æ˜¯éšŠå‹"))
        }
        if (todayPeople[binding_1 - 1].partner_id != binding_2) {
            return (alert("é€™å…©å€‹äººç›®å‰ä¸æ˜¯éšŠå‹"))
        }
        todayPeople[binding_1 - 1].partner_id = 0;
        todayPeople[binding_2 - 1].partner_id = 0;
        show_message(`${todayPeople[binding_1 - 1].name} èˆ‡ ${todayPeople[binding_2 - 1].name} æˆåŠŸè§£é™¤ç¶å®š`)
        idle_people_update_to_div()
    }
    function speak(text) {
        // åˆ›å»º SpeechSynthesisUtterance å¯¹è±¡
        var msg = new SpeechSynthesisUtterance();
        // è®¾ç½®è¦æœ—è¯»çš„æ–‡æœ¬
        msg.text = text;
        // æ’­æ”¾è¯­éŸ³
        window.speechSynthesis.speak(msg);
    }
    function send_data() {
        const data_obj = { todayPeople: todayPeople, game_record: game_record, prepare_PK: prepare_PK, bulletin_board_message: bulletin_board_message }
        client.publish('Chill/server/data_refresh', JSON.stringify(data_obj));
    }
    function handle_delete_today_data() {
        const confirmed = confirm('ç¢ºå®šåˆªé™¤ä»Šæ—¥çš„è³‡æ–™å—ï¼Ÿ(ä¸€èˆ¬åªåœ¨å­˜å¥½è³‡æ–™å¾Œï¼Œè¦é–‹å§‹æ‰“ä¹‹å‰åˆªé™¤ï¼Œåˆªé™¤å¾Œè«‹å¥—ç”¨ç•¶æ—¥çƒæœ‰è³‡æ–™å†é–‹å§‹ä½¿ç”¨)')
        if (confirmed) {
            todayPeople = [];
            prepare_PK = [];
            empty_court_arr = [1, 2, 3, 4];
            game_record = [];
            bulletin_board_message = []
            save_data()
            load_data()
        }
    }
    function handle_binging() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        if (choosed_people.length > 4) {
            return (alert(`ç•¶å‰ç¶å®šåŠŸèƒ½ åªèƒ½æ¥å—æœ€å¤šå››äººç¶å®š`))
        }
        if (choosed_people.length < 2) {
            return (alert(`ç•¶å‰ç¶å®šåŠŸèƒ½ è‡³å°‘è¦å…©äººæ‰å¯ä»¥ç¶å®š`))
        }
        for (x in choosed_people) {
            const found = binding_team_list.some(function (row) {
                return row.includes(choosed_people[x].id);
            });
            if (found) {
                return (alert(`è«‹å…ˆç§»é™¤${choosed_people[x].name}çš„ç¶å®š å†é‡æ–°é€²è¡Œç¶å®š`))
            }
        }
        const temp_binding = [];
        choosed_people.forEach(obj => {
            temp_binding.push(obj.id)
            obj.choosed = 0;
        })
        binding_team_list.push(temp_binding)
        idle_people_update_to_div()
    }
    function handle_go_to_sleep() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        if (choosed_people.length == 0) {
            return (show_message("æ²’æœ‰é¸äºº æ“ä½œç„¡æ•ˆ"))
        }
        choosed_people.forEach(obj => {
            obj.idleRounds = -999;
            obj.choosed = 0;
        })
        idle_people_update_to_div()
    }
    function handle_go_to_wait() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        if (choosed_people.length == 0) {
            return (show_message("æ²’æœ‰é¸äºº æ“ä½œç„¡æ•ˆ"))
        }
        choosed_people.forEach(obj => {
            obj.idleRounds = 0;
            obj.choosed = 0;
        })
        idle_people_update_to_div()
    }
    function handle_cancel_binding() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        const team_id_list = []
        choosed_people.forEach(obj => team_id_list.push(obj.id))
        var index = binding_team_list.findIndex(function (row) {
            return row.every(function (value, i) {
                return value === team_id_list[i];
            });
        });
        if (index != -1) {
            binding_team_list.splice(index, 1)
            choosed_people.forEach(obj => {
                obj.choosed = 0;
            })
            idle_people_update_to_div()
        } else {
            return (alert("è«‹æ­£ç¢ºæŒ‡å®šç§»é™¤ç¶å®šå°è±¡ï¼ˆå¿…é ˆæ˜¯åŒä¸€çµ„çš„å…¨éƒ¨äººï¼‰"))
        }
    }
    function handle_cancel_choosed() {
        const choosed_people = todayPeople.filter(obj => obj.choosed == 1)
        choosed_people.forEach(obj => {
            obj.choosed = 0;
        })
        idle_people_update_to_div()
    }
    function handle_record_score() {
        const now_which_game = parseInt($("#which_game").val())
        const top_team_score = parseInt($("#top_team_score").val())
        const bottom_team_score = parseInt($("#bottom_team_score").val())
        if (isNaN(top_team_score) || isNaN(bottom_team_score)) {
            return (alert("è«‹å…ˆå¡«å…¥åˆ†æ•¸ å†é€²è¡Œç™»è¨˜"))
        }
        const temp_game_record = []
        temp_game_record.push(todayPeople[wait_to_register_list[now_which_game][0] - 1].name)
        temp_game_record.push(todayPeople[wait_to_register_list[now_which_game][1] - 1].name)
        temp_game_record.push(todayPeople[wait_to_register_list[now_which_game][2] - 1].name)
        temp_game_record.push(todayPeople[wait_to_register_list[now_which_game][3] - 1].name)
        temp_game_record.push(top_team_score)
        temp_game_record.push(bottom_team_score)
        temp_game_record.push(new Date())

        game_record.push(temp_game_record)
        const score_diff_scale = score_count == '1' ? 10 : score_count == 2 ? 20 : 10
        //è¨ˆç®—åˆ†æ•¸ï¼š
        const score_diff = top_team_score - bottom_team_score
        todayPeople[wait_to_register_list[now_which_game][0] - 1].score += score_diff * score_diff_scale
        todayPeople[wait_to_register_list[now_which_game][1] - 1].score -= score_diff * score_diff_scale
        todayPeople[wait_to_register_list[now_which_game][2] - 1].score -= score_diff * score_diff_scale
        todayPeople[wait_to_register_list[now_which_game][3] - 1].score += score_diff * score_diff_scale
        //è¨­ç½®æœ€ä½åˆ†æ˜¯100
        todayPeople[wait_to_register_list[now_which_game][0] - 1].score = todayPeople[wait_to_register_list[now_which_game][3] - 1].score < 100 ? 100 : todayPeople[wait_to_register_list[now_which_game][3] - 1].score
        todayPeople[wait_to_register_list[now_which_game][1] - 1].score = todayPeople[wait_to_register_list[now_which_game][3] - 1].score < 100 ? 100 : todayPeople[wait_to_register_list[now_which_game][3] - 1].score
        todayPeople[wait_to_register_list[now_which_game][2] - 1].score = todayPeople[wait_to_register_list[now_which_game][3] - 1].score < 100 ? 100 : todayPeople[wait_to_register_list[now_which_game][3] - 1].score
        todayPeople[wait_to_register_list[now_which_game][3] - 1].score = todayPeople[wait_to_register_list[now_which_game][3] - 1].score < 100 ? 100 : todayPeople[wait_to_register_list[now_which_game][3] - 1].score

        wait_to_register_list.splice(now_which_game, 1)

        $('#myModal').modal('hide');
        show_message("å®Œæˆç™»è¨˜")
        idle_people_update_to_div()
        refresh_wait_to_register_text()


    }
    function handle_open_modal_of_record_score() {
        if (wait_to_register_list.length == 0) {
            return (alert("æ²’æœ‰éœ€è¦ç™»è¨˜çš„å ´æ¬¡"))
        }
        $("#which_game").empty()
        wait_to_register_list.forEach((obj, index) => {
            $("#which_game").append(`<option value="${index}">${todayPeople[obj[0] - 1].name} & ${todayPeople[obj[3] - 1].name} V.S. ${todayPeople[obj[1] - 1].name} ${todayPeople[obj[2] - 1].name} </option>`)
        })
        $("#player-1-td").html(todayPeople[wait_to_register_list[0][0] - 1].name)
        $("#player-2-td").html(todayPeople[wait_to_register_list[0][1] - 1].name)
        $("#player-3-td").html(todayPeople[wait_to_register_list[0][2] - 1].name)
        $("#player-4-td").html(todayPeople[wait_to_register_list[0][3] - 1].name)
        $("#which_game").change(handle_which_game_change)
        $('#myModal').modal('show');


    }
    function handle_which_game_change() {
        const now_which_game = parseInt($("#which_game").val())
        $("#player-1-td").html(todayPeople[wait_to_register_list[now_which_game][0] - 1].name)
        $("#player-2-td").html(todayPeople[wait_to_register_list[now_which_game][1] - 1].name)
        $("#player-3-td").html(todayPeople[wait_to_register_list[now_which_game][2] - 1].name)
        $("#player-4-td").html(todayPeople[wait_to_register_list[now_which_game][3] - 1].name)
    }

    function handle_delete_record_score() {
        const now_which_game = parseInt($("#which_game").val())
        const confirmed = confirm(`ä½ ç¢ºå®šè¦åˆªé™¤${todayPeople[wait_to_register_list[now_which_game][0] - 1].name} & ${todayPeople[wait_to_register_list[now_which_game][3] - 1].name} V.S. ${todayPeople[wait_to_register_list[now_which_game][1] - 1].name} ${todayPeople[wait_to_register_list[now_which_game][2] - 1].name} é€™å€‹å°å±€çš„ç´€éŒ„å—ï¼Ÿ ä¸€èˆ¬åªåœ¨æŒ‰éŒ¯å ´æ¬¡ä¸Šå ´ è¶•å¿«æŒ‰ä¸‹ä¾† è¦æ¸…é™¤é€™å€‹éŒ¯èª¤ä½¿ç”¨ï¼`)
        if (confirmed) {
            wait_to_register_list.splice(now_which_game, 1)
            show_message("æˆåŠŸåˆªé™¤å ´æ¬¡ç´€éŒ„")
            $('#myModal').modal('hide');
            refresh_wait_to_register_text()
        }
    }

    function refresh_wait_to_register_text() {
        $("#wait_to_register_text").html(`ç­‰å¾…ç™»è¨˜å ´æ¬¡: ${wait_to_register_list.length}`)
    }
    refresh_wait_to_register_text()
    idle_people_update_to_div()
    $("#pickPeople").on("click", pickPeople)
    $("#go_to_pk").on("click", go_to_PK)
    // $(".gameEnd").on("click", handle_end_game)
    $(".gameEnd").on("click", handle_end_game_new)
    $("#check-info").on("click", handle_check_info)
    $("#refresh-idle").on("click", idle_people_update_to_div)
    $("#save-data").on("click", save_data)
    $("#prepare_to_delete").on("click", prepare_to_delete)
    $("#min_idle").on("change", set_min_idle)
    $('#set_idle').on("click", set_idle)
    $('#set_prepare_PK').on("click", set_prepare_PK)
    $("#hide_score").on("change", handle_hide_score_change)
    $("#score_count").on("change", handle_score_count_change)
    $("#simplify_do").on("change", handle_simplify_do_change)
    $("#off_court_check").on("change", handle_off_court_check_change)
    $("#show_game_record").on('click', handle_show_game_record)
    $("#set_personal_record").on('click', handle_set_personal_record)
    $("#set_personal_record").on('click', handle_set_personal_record)
    $("#set_binding").on('click', handle_set_binding)
    $("#set_unbinding").on('click', handle_set_unbinding)
    $("#delete_today_data").on('click', handle_delete_today_data)
    $("#binding").on("click", handle_binging)
    $("#go_to_sleep").on("click", handle_go_to_sleep)
    $("#go_to_wait").on("click", handle_go_to_wait)
    $("#cancel_binding").on("click", handle_cancel_binding)
    $("#cancel_choosed").on("click", handle_cancel_choosed)
    $("#record_score").on("click", handle_record_score)
    $("#open_modal_of_record_score").on("click", handle_open_modal_of_record_score)
    $("#delete_record_score").on("click", handle_delete_record_score)





    var client = mqtt.connect("wss://test.mosquitto.org:8081") // you add a ws:// url here

    client.on('connect', () => {
        console.log('connected.');

        $("#send_data").click(function () {
            const data_obj = { todayPeople: todayPeople, game_record: game_record, prepare_PK: prepare_PK, bulletin_board_message: bulletin_board_message }
            client.publish('Chill/server/data_refresh', JSON.stringify(data_obj));
        })
        client.publish('Chill/test', "start");
        client.subscribe('Chill/#')
        client.on("message", function (topic, payload) {
            console.log(topic);
            var my_string = new TextDecoder().decode(payload);
            if (topic == 'Chill/client/register_personal_data') {
                const personal_data_obj = JSON.parse(my_string)
                console.log(personal_data_obj)
                if (todayPeople.filter(obj => obj.name == personal_data_obj.name).length == 0) {
                    todayPeople.push({ id: todayPeople.length, name: `${personal_data_obj.name} `, score: 500, court: 0, idleRounds: 0, player: 0, partner_id: 0, choosed: 0 });
                    put_todayPeople_to_court();
                    idle_people_update_to_div();
                    const return_obj = { success: '1', message: `æ‚¨ä½¿ç”¨ ${personal_data_obj.name} è¨»å†ŠæˆåŠŸ`, name: personal_data_obj.name }
                    client.publish('Chill/server/register', JSON.stringify(return_obj));
                } else {
                    const return_obj = { success: '0', message: `æ‚¨ä½¿ç”¨ ${personal_data_obj.name} è¨»å†Šå¤±æ•—ï¼Œå·²ç¶“æœ‰é€™å€‹åå­—äº†ï¼`, name: personal_data_obj.name }
                    client.publish('Chill/server/register', JSON.stringify(return_obj));
                }
            }
            if (topic == 'Chill/client/ask_for_data_refresh') {
                const data_obj = { todayPeople: todayPeople, game_record: game_record, prepare_PK: prepare_PK, bulletin_board_message: bulletin_board_message }
                client.publish('Chill/server/data_refresh', JSON.stringify(data_obj));
            }
        });
    });

</script>

<script>
     function isOverlap(choice_1, choice_2) {
        if (choice_1["Rankå°¾"] < choice_2["Ranké ­"] || choice_2["Rankå°¾"] < choice_1["Ranké ­"]) {
            return false;
        } else {
            return true;
        }
    }
    function waiting_count(choice, people_ready_fight) {
        let person_1 = choice['Ranké ­'];
        let person_2 = choice['Rankå°¾'];

        let team_list = [];
        for (let i = person_1; i <= person_2; i++) {
            team_list.push(people_ready_fight[i]['idleRounds']);
        }

        let temp = 0;
        for (let i = 0; i < team_list.length; i++) {
            temp += Math.pow(10, team_list[i]);
        }

        return temp;
    }
    function letsPlay(people_ori) {
        const people=people_ori.filter(person => person['court'] == 0 && person['idleRounds']>=0);
        let people_ready_fight=people.sort((a,b) => b['score']-a['score'])
        console.log('let people_ready_fight', people_ready_fight)
        console.log('people_ori', people_ori)
        // step1 å–å¾—å‚™æˆ°åå–®
        // let people_ready_fight = people.filter(person => person['court'] == 0 && person['idleRounds']>=0); //idleRounds>=0
        console.log('people_ready_fight', people_ready_fight)
        let matches = [];
        // step2 åˆ—èˆ‰çµ„åˆ
        for (let i = 0; i < people_ready_fight.length - 3; i++) {
            matches.push({
                "1è™Ÿ": people_ready_fight[i]['score'],
                "2è™Ÿ": people_ready_fight[i + 1]['score'],
                "3è™Ÿ": people_ready_fight[i + 2]['score'],
                "4è™Ÿ": people_ready_fight[i + 3]['score'],
                "æˆ°åŠ›": `${(people_ready_fight[i]['score'] + people_ready_fight[i + 3]['score']).toString().padStart(4)} vs ${(people_ready_fight[i + 1]['score'] + people_ready_fight[i + 2]['score']).toString().padStart(4)}`,
                "ç¸½åˆ†": people_ready_fight.slice(i, i + 4).reduce((sum, person) => sum + person['score'], 0),
                "éšŠä¼å·®": Math.abs((people_ready_fight[i]['score'] + people_ready_fight[i + 3]['score']) - (people_ready_fight[i + 1]['score'] + people_ready_fight[i + 2]['score'])),
                "æ¨™æº–å·®": +(math.std(people_ready_fight.slice(i, i + 4).map(person => person['score'])).toFixed(1)),
                "çµ„å…§å·®": people_ready_fight[i]['score'] - people_ready_fight[i + 3]['score'],
                "Ranké ­": i,
                "Rankå°¾": i + 3
            });
        }
        console.log('matches', matches)
        // step3 æ’åºçµ„åˆ
        let sorted_matches = matches.sort((match1, match2) => match1['æ¨™æº–å·®'] - match2['æ¨™æº–å·®']);
        console.log('sorted_matches', sorted_matches)
        // step4 çµ„åˆçš„çµ„åˆ
        let solutions = [];
        for (let i = 0; i < sorted_matches.length - 1; i++) {
            for (let j = i + 1; j < sorted_matches.length; j++) {
                if (!isOverlap(sorted_matches[i], sorted_matches[j])) {
                    solutions.push({
                        "Choice_1": i,
                        "Choice_2": j,
                        "SD_1": sorted_matches[i]['æ¨™æº–å·®'],
                        "SD_2": sorted_matches[j]['æ¨™æº–å·®'],
                        "SD_ALL": +(sorted_matches[i]['æ¨™æº–å·®'] + sorted_matches[j]['æ¨™æº–å·®']).toFixed(1),
                        "ç­‰å¾…æ•¸å€¼_1": waiting_count(sorted_matches[i], people_ready_fight),
                        "ç­‰å¾…æ•¸å€¼_2": waiting_count(sorted_matches[j], people_ready_fight),
                        "ç­‰å¾…æ•¸å€¼_åˆ": waiting_count(sorted_matches[i], people_ready_fight) + waiting_count(sorted_matches[j], people_ready_fight)
                    });
                }
            }
        }
        console.log('solutions', solutions)
        // step5 çµ„åˆä¾ ç¸½ï¼³ï¼¤æ’åº
        const sorted_solutions = solutions.sort((a, b) => a.SD_ALL - b.SD_ALL);
        console.log('sorted_solutions', sorted_solutions)
        // step6 æ‰¾å‡ºç­‰å¾…å€¼æœ€å¤§ä¹‹ä¸­ï¼Œï¼³ï¼¤æœ€å°çš„é¸æ“‡ï¼Œå†é¸æ“‡å…¶ä¸­è¼ƒå°çš„ï¼³ï¼¤çš„éšŠæˆ°
        const waiting_max = Math.max(...solutions.map(sol => sol.ç­‰å¾…æ•¸å€¼_åˆ));
        console.log("waiting_max", waiting_max)
        let next_game_players;
        for (const sol of sorted_solutions) {
            if (sol.ç­‰å¾…æ•¸å€¼_åˆ === waiting_max) {
                console.log("choice!!")
                if (sol.SD_1*10-sol.ç­‰å¾…æ•¸å€¼_1 <= sol.SD_2*10-sol.ç­‰å¾…æ•¸å€¼_2) {
                    console.log("choice_1")
                    next_game_players = sol.Choice_1;
                    
                }else{
                    console.log("choice_2")
                    next_game_players = sol.Choice_2;
                }
                break;
            }
        }
        const result = [];
        
        for (let i = sorted_matches[next_game_players]["Ranké ­"]; i <= sorted_matches[next_game_players]["Rankå°¾"]; i++) {
            result.push(people_ready_fight[i]['id']);
        }
        console.log(result)
        return result
    }

</script>